<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly テスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-left: 4px solid #007cba;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a87; }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🦀 WebAssembly 動作確認テスト</h1>
    
    <div class="test-section">
        <h2>📦 WebAssembly モジュール読み込みテスト</h2>
        <button onclick="testWasmLoading()">WebAssemblyを読み込む</button>
        <div id="wasm-loading-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🧪 基本関数テスト</h2>
        <button onclick="testBasicFunctions()">基本関数をテスト</button>
        <div id="basic-functions-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🔄 SeedCalculator 統合テスト</h2>
        <button onclick="testSeedCalculator()">SeedCalculatorをテスト</button>
        <div id="seed-calculator-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>⚡ パフォーマンステスト</h2>
        <button onclick="testPerformance()">パフォーマンステスト実行</button>
        <div id="performance-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🎮 実際のゲームシナリオテスト</h2>
        <button onclick="testGameScenario()">ゲームシナリオテスト実行</button>
        <div id="game-scenario-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>📝 ログ</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">ログクリア</button>
    </div>

    <script type="module">
        import { SeedCalculator } from './src/lib/seed-calculator.ts';
        import { initWasm, getWasm } from './src/lib/wasm-interface.ts';

        let calculator = null;
        let wasmModule = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const prefix = {
                'info': '📝',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            }[type] || '📝';
            
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function setResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        window.testWasmLoading = async function() {
            log('WebAssembly モジュールの読み込みを開始...');
            try {
                wasmModule = await initWasm();
                calculator = new SeedCalculator();
                const wasmInitialized = await calculator.initializeWasm();
                
                if (wasmInitialized && wasmModule) {
                    const testResult = wasmModule.test_wasm();
                    setResult('wasm-loading-result', `WebAssembly 読み込み成功: ${testResult}`, true);
                    log(`WebAssembly モジュール読み込み成功: ${testResult}`, 'success');
                } else {
                    setResult('wasm-loading-result', 'WebAssembly 読み込み失敗（TypeScript実装を使用）', false);
                    log('WebAssembly 読み込み失敗、TypeScript実装にフォールバック', 'warning');
                }
            } catch (error) {
                setResult('wasm-loading-result', `エラー: ${error.message}`, false);
                log(`WebAssembly 読み込みエラー: ${error.message}`, 'error');
            }
        };

        window.testBasicFunctions = async function() {
            if (!wasmModule) {
                setResult('basic-functions-result', 'WebAssemblyが読み込まれていません', false);
                return;
            }

            try {
                log('基本関数のテストを開始...');
                
                // エンディアン変換テスト
                const endian32 = wasmModule.to_little_endian_32(0x12345678);
                const endian16 = wasmModule.to_little_endian_16(0x1234);
                log(`エンディアン変換: 32bit=0x${endian32.toString(16)}, 16bit=0x${endian16.toString(16)}`);

                // SHA-1ハッシュテスト
                const testMessage = new Uint32Array([0x12345678, 0x9ABCDEF0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                const hashResult = wasmModule.calculate_sha1_hash(testMessage);
                log(`SHA-1ハッシュ: [${hashResult[0].toString(16)}, ${hashResult[1].toString(16)}]`);

                // バッチ計算テスト
                const batchMessages = new Uint32Array(32); // 2メッセージ x 16要素
                batchMessages.set([0x11111111, 0x22222222, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 0);
                batchMessages.set([0x33333333, 0x44444444, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 16);
                const batchResult = wasmModule.calculate_sha1_batch(batchMessages, 2);
                log(`バッチ計算: [${batchResult.map(x => x.toString(16)).join(', ')}]`);

                setResult('basic-functions-result', '全ての基本関数が正常に動作しました', true);
                log('基本関数テスト完了', 'success');
            } catch (error) {
                setResult('basic-functions-result', `エラー: ${error.message}`, false);
                log(`基本関数テストエラー: ${error.message}`, 'error');
            }
        };

        window.testSeedCalculator = async function() {
            if (!calculator) {
                setResult('seed-calculator-result', 'SeedCalculatorが初期化されていません', false);
                return;
            }

            try {
                log('SeedCalculator 統合テストを開始...');
                
                const isUsingWasm = calculator.isUsingWasm();
                log(`実装: ${isUsingWasm ? 'WebAssembly' : 'TypeScript'}`);

                // テストメッセージでの計算
                const testMessage = [0x12345678, 0x9ABCDEF0, 0x11111111, 0x22222222,
                                   0x33333333, 0x44444444, 0x55555555, 0x66666666,
                                   0x77777777, 0x88888888, 0x99999999, 0xAAAAAAAA,
                                   0xBBBBBBBB, 0xCCCCCCCC, 0xDDDDDDDD, 0xEEEEEEEE];

                const result = calculator.calculateSeed(testMessage);
                log(`計算結果: seed=0x${result.seed.toString(16)}, hash=${result.hash}`);

                // 一貫性テスト
                const result2 = calculator.calculateSeed(testMessage);
                const isConsistent = result.seed === result2.seed && result.hash === result2.hash;
                log(`一貫性テスト: ${isConsistent ? '成功' : '失敗'}`);

                setResult('seed-calculator-result', 
                    `SeedCalculator動作確認完了 (${isUsingWasm ? 'WebAssembly' : 'TypeScript'})\\n` +
                    `Seed: 0x${result.seed.toString(16)}\\n` +
                    `Hash: ${result.hash}\\n` +
                    `一貫性: ${isConsistent ? '✓' : '✗'}`, true);
                
                log('SeedCalculator 統合テスト完了', 'success');
            } catch (error) {
                setResult('seed-calculator-result', `エラー: ${error.message}`, false);
                log(`SeedCalculator テストエラー: ${error.message}`, 'error');
            }
        };

        window.testPerformance = async function() {
            if (!calculator) {
                setResult('performance-result', 'SeedCalculatorが初期化されていません', false);
                return;
            }

            try {
                log('パフォーマンステストを開始...');
                
                const testMessage = [0x12345678, 0x9ABCDEF0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                const iterations = 10000;
                
                const startTime = performance.now();
                
                for (let i = 0; i < iterations; i++) {
                    calculator.calculateSeed(testMessage);
                }
                
                const endTime = performance.now();
                const elapsedTime = endTime - startTime;
                const calcPerSec = Math.round(iterations / elapsedTime * 1000);
                
                const implementation = calculator.isUsingWasm() ? 'WebAssembly' : 'TypeScript';
                log(`${implementation}: ${iterations}回計算 = ${elapsedTime.toFixed(1)}ms (${calcPerSec} calc/sec)`);
                
                setResult('performance-result', 
                    `パフォーマンステスト完了\\n` +
                    `実装: ${implementation}\\n` +
                    `${iterations}回計算: ${elapsedTime.toFixed(1)}ms\\n` +
                    `性能: ${calcPerSec.toLocaleString()} calc/sec`, true);
                
                log('パフォーマンステスト完了', 'success');
            } catch (error) {
                setResult('performance-result', `エラー: ${error.message}`, false);
                log(`パフォーマンステストエラー: ${error.message}`, 'error');
            }
        };

        window.testGameScenario = async function() {
            if (!calculator) {
                setResult('game-scenario-result', 'SeedCalculatorが初期化されていません', false);
                return;
            }

            try {
                log('実際のゲームシナリオテストを開始...');
                
                // ポケモンBW JPN版の典型的なシナリオ
                const conditions = {
                    romVersion: 'B',
                    romRegion: 'JPN',
                    hardware: 'DS',
                    timer0Range: { min: 1000, max: 1000, useAutoRange: false },
                    vcountRange: { min: 95, max: 95, useAutoRange: false },
                    dateRange: {
                        startYear: 2011, startMonth: 3, startDay: 6,
                        startHour: 12, startMinute: 0, startSecond: 0,
                        endYear: 2011, endMonth: 3, endDay: 6,
                        endHour: 12, endMinute: 0, endSecond: 0
                    },
                    keyInput: 0,
                    macAddress: [0x00, 0x09, 0xBF, 0x12, 0x34, 0x56]
                };

                const datetime = new Date(2011, 2, 6, 12, 0, 0); // 2011/03/06 12:00:00
                
                // メッセージ生成
                const message = calculator.generateMessage(conditions, 1000, 95, datetime);
                log(`生成メッセージ: [${message.slice(0, 4).map(x => '0x' + x.toString(16)).join(', ')}, ...]`);

                // シード計算
                const result = calculator.calculateSeed(message);
                log(`計算結果: seed=0x${result.seed.toString(16)}, hash=${result.hash}`);

                // 複数パターンテスト
                const testResults = [];
                for (let timer0 = 1000; timer0 <= 1002; timer0++) {
                    const msg = calculator.generateMessage(conditions, timer0, 95, datetime);
                    const res = calculator.calculateSeed(msg);
                    testResults.push(`Timer0=${timer0}: 0x${res.seed.toString(16)}`);
                }
                
                log(`複数パターンテスト: ${testResults.join(', ')}`);

                const implementation = calculator.isUsingWasm() ? 'WebAssembly' : 'TypeScript';
                
                setResult('game-scenario-result', 
                    `ゲームシナリオテスト完了\\n` +
                    `実装: ${implementation}\\n` +
                    `Date: 2011/03/06 12:00:00\\n` +
                    `Timer0=1000, VCount=95\\n` +
                    `結果: 0x${result.seed.toString(16)}\\n` +
                    `Hash: ${result.hash}`, true);
                
                log('ゲームシナリオテスト完了', 'success');
            } catch (error) {
                setResult('game-scenario-result', `エラー: ${error.message}`, false);
                log(`ゲームシナリオテストエラー: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').textContent = '';
        };

        // 初期化
        log('テストページ読み込み完了');
        log('WebAssemblyテストを開始するには、各ボタンをクリックしてください');
    </script>
</body>
</html>
