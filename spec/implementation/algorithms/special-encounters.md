# 特殊エンカウントの詳細仕様

## 特殊エンカウントの種類と特徴

BW/BW2では通常の野生エンカウントに加えて、特殊条件で発生するエンカウントが存在する：

### 揺れる草むら（ShakingGrass）
- 通常の草むらより高レベルのポケモンが出現
- 隠れ特性を持つポケモンの出現率が高い
- レベル範囲: 35-50（通常草むらより約10-15レベル高い）

### 砂煙（DustCloud）
- ポケモンだけでなくジュエルや進化石も出現する可能性
- 出現内容の判定は性格値乱数で決定
- ドリュウズなど特定ポケモンの出現場所として重要

### ポケモンの影（PokemonShadow）
- 橋や建物の影の下で発生
- エリア固有のポケモンが出現
- 通常エンカウントでは出現しないポケモンが含まれる場合

### 水泡（SurfingBubble/FishingBubble）
- なみのりエリア・釣りエリアでの特殊エンカウント
- 水上・水中での特殊条件で発生
- 通常の水上エンカウントより高レベル・レアポケモン

## 特殊エンカウントの乱数消費パターン

特殊エンカウントは通常エンカウントと同じ乱数消費パターンを使用：

```rust
// 特殊エンカウント共通処理
pub fn process_special_encounter(&mut self, encounter_type: u32) -> EncounterResult {
    // Step 1: シンクロ判定
    let sync_check = self.rng.sync_check(); // r1[n] 消費
    
    // Step 2: 性格決定
    let nature_id = if sync_check && sync_enabled {
        sync_nature_id // シンクロ成功
    } else {
        self.rng.nature_roll() // r1[n+1] 消費
    };
    
    // Step 3: 遭遇スロット決定
    let slot_value = match self.game_version {
        GameVersion::BlackWhite => self.rng.encounter_slot_bw(),   // r1[n+2] 消費
        GameVersion::BlackWhite2 => self.rng.encounter_slot_bw2(), // r1[n+2] 消費
    };
    
    // Step 4: レベル乱数生成（エンカウントタイプ依存）
    let level_rand = match encounter_type {
        0 | 3..=5 => {
            // 通常・特殊エンカウント: エンカウントテーブルに固定レベル埋め込み
            // 乱数は生成されるが結果は使用されない（スキップ扱い）
            self.rng.next() // r1[n+3] 消費（スキップ）
        },
        1 | 2 | 6 | 7 => {
            // なみのり・釣り・水泡系: レベル範囲からランダム選択
            self.rng.next() // r1[n+3] 消費（実際のレベル計算はTypeScript側）
        },
        _ => 0, // 固定シンボル等は乱数消費なし
    };
    
    // Step 5: 性格値生成（特殊エンカウントも野生扱い）
    let pid = self.rng.next() ^ 0x00010000; // r1[n+4] 消費
    
    // 生の乱数値をTypeScript側に渡して詳細計算を実行
}
```

## レベル計算の実装方針

### WASM側（Rust）
- 乱数消費の管理のみ実行
- エンカウントタイプに応じて乱数を生成またはスキップ
- 生の乱数値をTypeScript側に渡す

### TypeScript側
- エンカウントテーブル情報の保持
- 生の乱数値とエンカウントテーブルを組み合わせてレベル計算
- エリア・バージョン・釣り竿タイプ等の詳細条件を考慮

## 各特殊エンカウントの遭遇テーブル

### 揺れる草むら（エンカウントタイプ3）
```rust
fn shaking_grass_slot(&self, slot: u32) -> usize {
    // 揺れる草むら（特殊エンカウント）
    // 通常より高レベル・レアポケモンが出現
    match slot {
        0..=39 => 0,   // 40%
        40..=59 => 1,  // 20%
        60..=79 => 2,  // 20%
        80..=94 => 3,  // 15%
        _ => 4,        // 5% (隠れ特性持ち等)
    }
}
```

### 砂煙（エンカウントタイプ4）
```rust
fn dust_cloud_slot(&self, slot: u32) -> usize {
    // 砂煙（特殊エンカウント）
    // ポケモンまたはジュエル・進化石が出現
    match slot {
        0..=69 => 0,   // 70% ポケモン
        70..=89 => 1,  // 20% ジュエル類
        _ => 2,        // 10% 進化石類
    }
}
```

### ポケモンの影（エンカウントタイプ5）
```rust
fn pokemon_shadow_slot(&self, slot: u32) -> usize {
    // ポケモンの影（特殊エンカウント）
    // 橋や建物の影で出現
    match slot {
        0..=49 => 0,   // 50%
        50..=79 => 1,  // 30%
        80..=94 => 2,  // 15%
        _ => 3,        // 5%
    }
}
```

### 水泡なみのり（エンカウントタイプ6）
```rust
fn surfing_bubble_slot(&self, slot: u32) -> usize {
    // 水泡（なみのり版特殊エンカウント）
    // なみのりエリアでの特殊遭遇
    match slot {
        0..=49 => 0,   // 50%
        50..=79 => 1,  // 30%
        80..=94 => 2,  // 15%
        _ => 3,        // 5%
    }
}
```

### 水泡釣り（エンカウントタイプ7）
```rust
fn fishing_bubble_slot(&self, slot: u32) -> usize {
    // 水泡釣り（釣り版特殊エンカウント）
    // 釣りエリアでの特殊遭遇
    match slot {
        0..=59 => 0,   // 60%
        60..=84 => 1,  // 25%
        85..=94 => 2,  // 10%
        _ => 3,        // 5%
    }
}
```

## 実装上の注意点

### 乱数消費パターン
- 特殊エンカウントは基本的に野生エンカウントと同じ乱数消費パターン
- 遭遇スロットテーブルのみが通常エンカウントと異なる
- レベル計算は実際のエンカウントテーブル情報が必要なためTypeScript側で実行

### レベル決定方式
- **通常・特殊エンカウント（0, 3-5）**: エンカウントテーブルに固定レベル埋め込み
  - レベル乱数は生成されるがスキップ扱い
- **なみのり・釣り・水泡系（1, 2, 6, 7）**: レベル範囲内からランダム選択
  - レベル乱数値が実際に使用される

### 特殊な出現判定
- **砂煙**: ポケモン/ジュエル/進化石の判定が必要
- **隠れ特性**: 揺れる草むらでの隠れ特性出現率
- **レアポケモン**: 特殊エンカウント限定ポケモンの存在

### TypeScript側での詳細実装
- エンカウントテーブル定義とレベル範囲情報
- エリア別・バージョン別の出現ポケモン管理
- 釣り竿タイプによる出現テーブル切り替え
- アイテム出現時の処理分岐
