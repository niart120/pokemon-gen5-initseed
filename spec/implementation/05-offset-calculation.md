# 05. オフセット計算仕様（BW/BW2）


---


## 1. 用語・定義

| 用語               | 定義・説明 |
|--------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| **オフセット**     | ゲーム起動後、初期seedからどれだけ乱数が消費されたか（進行したか）を表す値。TID/SID決定やゲーム開始直後の乱数状態を特定するために用いる。 |
| **乱数（Rand）**   | 線形合同法で生成されるseedの上位32bit値。イベントや内部処理ごとに消費され、乱数列の進行を示す。                                  |
| **SHA1**           | 52バイトのゲーム内部データをSHA-1ハッシュ化し、64bit整数値（初期seed/S0）を生成する処理。ゲーム起動時のseed決定処理で用いる。             |
| **初期seed（S0）** | ゲーム起動時にSHA-1から得られる乱数生成の出発点となる64bit値。乱数列生成のスタート地点として扱う。                                    |
| **線形合同法**     | 乱数列を生成するための数式。S[n+1] = S[n] * 0x5D588B656C078965 + 0x269EC3（mod 2^64）でseedを進める。上位32bitを乱数値として使用。                                    |
| **Probability Table（PT）** | 乱数値を確率分岐表に通し、分岐や次の処理を決める操作。`(R*101)>>32`でテーブル参照する。PT×nはn回繰り返すことを意味する。                                      |
| **PID**            | ポケモンの性格値（Personality ID）。乱数値そのまま、または一部ビット反転で決定される。                                                  |
| **TID/SID**        | プレイヤーの表ID（Trainer ID）および裏ID（Secret ID）。`(R*0xFFFFFFFF)>>32`の下位16bitがTID、上位16bitがSIDとなる。                                               |
| **表住人・裏住人** | ブラックシティ/ホワイトフォレストの住人。表住人10回、裏住人3回の乱数消費で決定される（合計13回）。                                      |
| **オフセット計算ツール** | offsetKeisan、RNG Reporter、バトルサブウェイ乱数補助ツールなど。各ツールでseed基準点やカウントが微妙に異なる場合がある。             |

---
- ゲームバージョン・開始方法ごとに乱数消費フローが異なる
- 詳細は [02-algorithms.md](./02-algorithms.md) も参照

---

### BW
- 始めから（セーブ有り/無し）
### BW2
- 始めから（思い出リンク有/無/セーブ無し）
- 続きから（思い出リンク有/無）
各分岐の乱数消費フロー詳細は下記「4. 詳細仕様」を参照。

---

## 4. 詳細仕様・アルゴリズム

### 線形合同法
S[n+1] = (S[n] * 0x5D588B656C078965 + 0x269EC3) mod 2^64
```
- `(R * 101) >> 32` による確率計算
- 6段階テーブル参照（L1～L6）

### 乱数消費フロー（バージョン別）
- 詳細は [offset_calculation_detailed.md](./offset_calculation_detailed.md) を参照
- ロジック概要は [offset_logic_summary.md](./offset_logic_summary.md) を参照

#### 例：BW 始めから（セーブ有り）
1. S0生成
2. Rand×1
3. PT×2
4. チラーミィPID決定
5. Rand×1（ID決定）
6. TID/SID決定
7. PT×4
8. 表住人10回、裏住人3回

#### 例：BW2 始めから（思い出リンク有）
1. S0生成
2. Rand×1
3. PT×1
4. Rand×2
6. Rand×2
7. チラチーノPID/ID/TID/SID決定

## 5. Probability Table（PT）操作詳細
- PT操作のアルゴリズムは [offset_calculation_detailed.md](./offset_calculation_detailed.md) の「4. Probability Table（PT）操作詳細」参照
- 乱数消費回数のカウント方法や分岐例も同ファイル参照

## 6. 住人決定・Extra処理
- 表住人10回、裏住人3回の乱数消費（BW）
- BW2「続きから」時のExtra処理は [offset_calculation_detailed.md](./offset_calculation_detailed.md) の「8. Extra処理」参照


- offsetKeisan等ツールとの比較時はseed基準点に注意
- 乱数消費回数の定義がツールごとに異なる場合あり
- 実装検証は [offset_logic_summary.md](./offset_logic_summary.md) の「検証方法」参照

---
- [02-algorithms.md](./02-algorithms.md) : 乱数生成・PT操作アルゴリズム
- [offset_logic_summary.md](./offset_logic_summary.md) : ロジック概要・検証方法

---

- BW/BW2のオフセット計算は、初期seed生成・乱数消費フロー・PT操作・住人決定・Extra処理など複数要素の正確な実装が必要
- 仕様詳細・検証方法は本ファイルおよび参照リンクを活用
