# ポケモンBW・BW2における「オフセット計算」ロジックまとめ

---

## 用語集

| 用語               | 定義・説明 |
|--------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| **オフセット**     | ゲーム起動後、初期seedからどれだけ乱数が消費されたか（進行したか）を表す値。TID/SID決定やゲーム開始直後の乱数状態を特定するために用いる。 |
| **乱数（Rand）**   | 線形合同法で生成されるseedの上位32bit値。イベントや内部処理ごとに消費され、乱数列の進行を示す。                                  |
| **SHA1**           | 52バイトのゲーム内部データをSHA-1ハッシュ化し、64bit整数値（初期seed/S0）を生成する処理。ゲーム起動時のseed決定処理で用いる。             |
| **初期seed（S0）** | ゲーム起動時にSHA-1から得られる乱数生成の出発点となる64bit値。乱数列生成のスタート地点として扱う。                                    |
| **線形合同法**     | 乱数列を生成するための数式。S[n+1] = S[n] * 0x5D588B656C078965 + 0x269EC3（mod 2^64）でseedを進める。上位32bitを乱数値として使用。                                    |
| **Probability Table（PT）** | 乱数値を確率分岐表に通し、分岐や次の処理を決める操作。`(R*101)>>32`でテーブル参照する。PT×nはn回繰り返すことを意味する。                                      |
| **PID**            | ポケモンの性格値（Personality ID）。乱数値そのまま、または一部ビット反転で決定される。                                                  |
| **TID/SID**        | プレイヤーの表ID（Trainer ID）および裏ID（Secret ID）。`(R*0xFFFFFFFF)>>32`の下位16bitがTID、上位16bitがSIDとなる。                                               |
| **表住人・裏住人** | ブラックシティ/ホワイトフォレストの住人。表住人10回、裏住人3回の乱数消費で決定される（合計13回）。                                      |
| **Extra**          | BW2で「続きから始める」際の追加乱数消費処理。3つの`(R*15)>>32`値がすべて異なるまで繰り返し進行する。                                          |
| **オフセット計算ツール** | offsetKeisan、RNG Reporter、バトルサブウェイ乱数補助ツールなど。各ツールでseed基準点やカウントが微妙に異なる場合がある。             |

---

## 1. 「オフセット」の定義

オフセットとは、ゲーム起動後に初期seedからどれだけ乱数を消費（進行）した状態で、プレイヤーが操作可能になるタイミングやTID・SID決定などのイベントに到達するかを表す値である。
「続きから始める」場合は、NPCやイベントによる乱数消費がない場所でゲームを始めた時点の乱数位置を示す。
「始めから」を選択した場合は、主人公のTID/SID決定直前の乱数位置を指す。
これによって、目的の乱数（たとえば色違いが出現するseed）がどの位置で現れるかを把握できる。

---

## 2. オフセット計算の概要フロー

### (1) 初期seedの決定

ゲーム起動時、内部の時刻やパラメータなど（52バイトのメッセージデータ）をSHA-1でハッシュ化し、64bitの値（これを初期seedまたはS0と呼ぶ）を得る。
S0が乱数列生成のスタート地点となる。

### (2) 乱数列の生成（線形合同法）

以降は線形合同法で次のseedを生成する。  
S[n+1] = S[n] * 0x5D588B656C078965 + 0x269EC3 (mod 2^64)
生成したseedの上位32bitを乱数値として使用する。

### (3) 乱数消費の流れ

ゲームの進行やイベントごとに、乱数値が1つずつ消費される（次のseedに進む）。
Rand×nは「n回乱数を消費した（n回seedを進めた）」という意味になる。

### (4) Probability Table (PT) 操作

特定のイベントではPT操作と呼ばれる乱数消費があり、乱数値を確率テーブルに通して分岐や次の操作を決定する。
PT×nとは、n回PT操作を実施することを意味する。

### (5) その他の操作

チラーミィや住人決定、TID/SID決定など、乱数の消費や分岐がイベントごとに細かく規定されている。

---

## 3. オフセット計算の例（BWの場合）

### 始めから（セーブデータ有り）の場合

1. SHA1でS0を生成する。
2. Rand ×1（S1に進む）。
3. PT ×2を実行する。
4. チラーミィ用PIDを決定する。
5. Rand ×1（チラーミィ用IDを決定する）。
6. TID/SIDを決定する。
7. PT ×4を実行する。
8. 表住人10回、裏住人3回の乱数消費（合計13回）。

### 続きから始める場合

1. SHA1を実行する。
2. Rand ×1を実行する。
3. PT ×5を実行する。

### BW2の場合

#### 始めから（思い出リンク済み）
1. SHA1 → Rand×1 → PT×1 → Rand×2 → PT×1 → Rand×2 → チラチーノPID → チラチーノID → TID/SID

#### 始めから（思い出リンク無し）
1. SHA1 → Rand×1 → PT×1 → Rand×3 → PT×1 → Rand×2 → チラチーノPID → チラチーノID → TID/SID

#### 続きから始める（思い出リンク済み）
1. SHA1 → Rand×1 → PT×1 → Rand×2 → PT×4 → Extra

#### 続きから始める（思い出リンク無し）
1. SHA1 → Rand×1 → PT×1 → Rand×3 → PT×4 → Extra

### 具体的な計算例
初期seed `672C1C3C3D71E125` の場合：

**TID/SID計算例:**
```
Frame 20のRand値: 0xEC8CA73C
(0xEC8CA73C * 0xFFFFFFFF) >> 32 = 0xEC8CA73B
TID = 0xA73B = 42811
SID = 0xEC8C = 60556
```

**PT操作例（一部）:**
```
Frame  Rand値     (R*101)>>32  判定
1      67FA0457   41           L1の50以下→L2へ
2      D6A4EF21   84           L2の50より大きい
...
11     27BE3D13   15           L5の33以下→L6へ
12     C6F25ADA   78           L6で処理完了
```

---

## 4. 注意事項

本まとめでの「オフセット」は、ゲーム起動直後の消費乱数数を指しており、「孵化乱数」や「配達員乱数」などで使われるオフセットとは区別が必要である。
イベントやNPCの動作によって追加で乱数消費が発生する場合がある（徘徊や大量発生、ジョインアベニューなど）。

---

## 5. まとめ

オフセット計算は、初期seedと乱数消費フロー（イベントごとの乱数消費ルール）を正確に把握・再現することで、希望する乱数状態でゲーム内イベントに到達できるようにするための手法である。

### 実装時の重要ポイント

1. **正確な線形合同法の実装**
   - `S[n+1] = (S[n] * 0x5D588B656C078965 + 0x269EC3) mod 2^64`
   - 上位32bitを乱数値として使用

2. **PT操作の正確な実装**
   - `(R * 101) >> 32` による確率計算
   - 6段階のテーブル参照ロジック

3. **バージョン別分岐の正確な実装**
   - BW/BW2の違い
   - セーブデータ有無による違い
   - 思い出リンクの有無による違い（BW2）

4. **住人決定処理の実装**
   - 表住人：10回の乱数消費
   - 裏住人：3回の乱数消費
   - 内部抽選ロジックは考慮不要

### 検証方法
実装したオフセット計算が正確であることを確認するには：
- 既知の初期seedでの実機動作と比較
- 既存ツールとの結果照合
- 複数パターンでの動作確認


