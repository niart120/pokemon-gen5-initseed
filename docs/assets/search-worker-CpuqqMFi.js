var U=Object.defineProperty;var H=(t,e,a)=>e in t?U(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var _=(t,e,a)=>H(t,typeof e!="symbol"?e+"":e,a);class F{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const a=1732584193,s=4023233417,c=2562383102,r=271733878,n=3285377520,u=new Array(80);for(let h=0;h<16;h++)u[h]=e[h];for(let h=16;h<80;h++)u[h]=this.leftRotate(u[h-3]^u[h-8]^u[h-14]^u[h-16],1);let o=a,l=s,i=c,m=r,g=n;for(let h=0;h<80;h++){let S;h<20?S=this.leftRotate(o,5)+(l&i|~l&m)+g+u[h]+1518500249&4294967295:h<40?S=this.leftRotate(o,5)+(l^i^m)+g+u[h]+1859775393&4294967295:h<60?S=this.leftRotate(o,5)+(l&i|l&m|i&m)+g+u[h]+2400959708&4294967295:S=this.leftRotate(o,5)+(l^i^m)+g+u[h]+3395469782&4294967295,g=m,m=i,i=this.leftRotate(l,30),l=o,o=S}let R=this.add32(a,o),w=this.add32(s,l),f=this.add32(c,i),p=this.add32(r,m),T=this.add32(n,g);return{h0:R,h1:w,h2:f,h3:p,h4:T}}leftRotate(e,a){return(e<<a|e>>>32-a)>>>0}add32(e,a){return(e+a&4294967295)>>>0}static hashToHex(e,a,s,c,r){return e.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")+c.toString(16).padStart(8,"0")+r.toString(16).padStart(8,"0")}}let b=null,z=null;async function I(){return b||z||(z=(async()=>{try{const t=await import("./wasm_pkg-dLjgnl_0.js");return await t.default(),b={swap_bytes_32_wasm:t.swap_bytes_32_wasm,swap_bytes_16_wasm:t.swap_bytes_16_wasm,calculate_sha1_hash:t.calculate_sha1_hash,calculate_sha1_batch:t.calculate_sha1_batch,IntegratedSeedSearcher:t.IntegratedSeedSearcher},b}catch(t){throw console.error("Failed to load WebAssembly module:",t),b=null,z=null,t}})(),z)}function k(){if(!b)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return b}class L{constructor(e){_(this,"wasm");this.wasm=e}toLittleEndian32(e){return this.wasm.swap_bytes_32_wasm(e)}toLittleEndian16(e){return this.wasm.swap_bytes_16_wasm(e)}calculateSeed(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words");const a=new Uint32Array(e),s=this.wasm.calculate_sha1_hash(a);if(s.length!==6)throw new Error("WebAssembly returned invalid result");const c=s[0],r=s[1],n=s[2],u=s[3],o=s[4],l=s[5],i=r.toString(16).padStart(8,"0")+n.toString(16).padStart(8,"0")+u.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+l.toString(16).padStart(8,"0");return{seed:c,hash:i}}calculateSeedBatch(e){if(e.length===0)return[];for(let r=0;r<e.length;r++)if(e[r].length!==16)throw new Error(`Message ${r} must be exactly 16 32-bit words`);const a=new Uint32Array(e.length*16);for(let r=0;r<e.length;r++)a.set(e[r],r*16);const s=this.wasm.calculate_sha1_batch(a,e.length);if(s.length!==e.length*6)throw new Error("WebAssembly batch calculation failed");const c=[];for(let r=0;r<e.length;r++){const n=s[r*6],u=s[r*6+1],o=s[r*6+2],l=s[r*6+3],i=s[r*6+4],m=s[r*6+5],g=u.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+l.toString(16).padStart(8,"0")+i.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0");c.push({seed:n,hash:g})}return c}}function x(t){return new L(t)}const B={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},$={DS:8,DS_LITE:6,"3DS":9};class V{constructor(){_(this,"sha1");_(this,"wasmCalculator",null);_(this,"useWasm",!1);this.sha1=new F}async initializeWasm(){try{const e=await I();return this.wasmCalculator=x(e),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&this.wasmCalculator!==null}getWasmCalculator(){return this.wasmCalculator}getWasmModule(){return k()}setUseWasm(e){if(e&&!this.wasmCalculator){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,a){const s=B[e];if(!s)return console.error(`ROM version not found: ${e}`),null;const c=s[a];return c?{nazo:[...c.nazo],vcountTimerRanges:c.vcountTimerRanges.map(r=>[...r])}:(console.error(`ROM region not found: ${a} for version ${e}`),null)}toLittleEndian32(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian32(e)}catch(a){console.warn("WebAssembly endian conversion failed, using TypeScript:",a)}return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian16(e)}catch(a){console.warn("WebAssembly endian conversion failed, using TypeScript:",a)}return(e&255)<<8|e>>>8&255}getDayOfWeek(e,a,s){return new Date(e,a-1,s).getDay()}generateMessage(e,a,s,c){const r=this.getROMParameters(e.romVersion,e.romRegion);if(!r)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const n=new Array(16).fill(0);for(let v=0;v<5;v++)n[v]=this.toLittleEndian32(r.nazo[v]);n[5]=this.toLittleEndian32(s<<16|a);const u=e.macAddress[4]<<8|e.macAddress[5];n[6]=u;const o=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,l=100663296,i=$[e.hardware],m=o^l^i;n[7]=this.toLittleEndian32(m);const g=c.getFullYear()%100,R=c.getMonth()+1,w=c.getDate(),f=this.getDayOfWeek(c.getFullYear(),R,w),p=Math.floor(g/10)*16+g%10,T=Math.floor(R/10)*16+R%10,h=Math.floor(w/10)*16+w%10,S=Math.floor(f/10)*16+f%10;n[8]=p<<24|T<<16|h<<8|S;const A=c.getHours(),C=c.getMinutes(),D=c.getSeconds(),E=(e.hardware==="DS"||e.hardware==="DS_LITE")&&A>=12?1:0,P=Math.floor(A/10)*16+A%10,M=Math.floor(C/10)*16+C%10,W=Math.floor(D/10)*16+D%10;return n[9]=E<<30|P<<24|M<<16|W<<8|0,n[10]=0,n[11]=0,n[12]=this.toLittleEndian32(e.keyInput),n[13]=2147483648,n[14]=0,n[15]=416,n}calculateSeed(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.calculateSeed(e)}catch(l){console.warn("WebAssembly calculation failed, falling back to TypeScript:",l)}const a=this.sha1.calculateHash(e),s=BigInt(this.toLittleEndian32(a.h0)),o=(BigInt(this.toLittleEndian32(a.h1))<<32n|s)*0x5D588B656C078965n+0x269EC3n;return{seed:Number(o>>32n&0xFFFFFFFFn),hash:F.hashToHex(a.h0,a.h1,a.h2,a.h3,a.h4)}}parseTargetSeeds(e){const a=e.split(`
`).map(n=>n.trim()).filter(n=>n.length>0),s=[],c=[],r=new Set;return a.forEach((n,u)=>{try{let o=n.toLowerCase();if(o.startsWith("0x")&&(o=o.substring(2)),!/^[0-9a-f]{1,8}$/.test(o)){c.push({line:u+1,value:n,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const l=parseInt(o,16);if(r.has(l))return;r.add(l),s.push(l)}catch{c.push({line:u+1,value:n,error:"Failed to parse as hexadecimal number."})}}),{validSeeds:s,errors:c}}getVCountForTimer0(e,a){for(const[s,c,r]of e.vcountTimerRanges)if(a>=c&&a<=r)return s;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}const N=86400;let d={isRunning:!1,isPaused:!1,shouldStop:!1},y;async function Y(){if(!y){y=new V;try{await y.initializeWasm()}catch(t){console.warn("WebAssembly failed in worker, using TypeScript fallback:",t)}}}async function G(t,e,a,s,c,r,n,u,o){const l=y.getWasmModule();if(l&&l.IntegratedSeedSearcher)try{const i=y.getROMParameters(t.romVersion,t.romRegion);if(!i)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const m=new l.IntegratedSeedSearcher(t.macAddress,new Uint32Array(i.nazo),t.hardware,t.keyInput,5,8),g=new Date(e),R=Math.floor((a-e)/1e3),w=m.search_seeds_integrated(g.getFullYear(),g.getMonth()+1,g.getDate(),g.getHours(),g.getMinutes(),g.getSeconds(),R,s,c,r,n,new Uint32Array(Array.from(u)));for(const f of w){const p=new Date(f.year,f.month-1,f.date,f.hour,f.minute,f.second),T=y.generateMessage(t,f.timer0,f.vcount,p),{hash:h}=y.calculateSeed(T),S={seed:f.seed,datetime:p,timer0:f.timer0,vcount:f.vcount,conditions:t,message:T,sha1Hash:h,isMatch:!0};o(S)}m.free();return}catch(i){console.error("Integrated search failed, falling back to individual processing:",i)}await J([e,a],t,s,r,u,y,o)}async function J(t,e,a,s,c,r,n){const[u,o]=t;for(let l=u;l<=o;l+=1e3){const i=new Date(l);try{const m=r.generateMessage(e,a,s,i),{seed:g,hash:R}=r.calculateSeed(m);c.has(g)&&n({seed:g,datetime:i,timer0:a,vcount:s,conditions:e,message:m,sha1Hash:R,isMatch:!0})}catch(m){console.error("Error calculating seed:",m)}}}async function K(t,e){try{await Y();const a=y.getROMParameters(t.romVersion,t.romRegion);if(!a)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const s=t.timer0Range.max-t.timer0Range.min+1,c=t.vcountRange.max-t.vcountRange.min+1,r=new Date(t.dateRange.startYear,t.dateRange.startMonth-1,t.dateRange.startDay,t.dateRange.startHour,t.dateRange.startMinute,t.dateRange.startSecond),n=new Date(t.dateRange.endYear,t.dateRange.endMonth-1,t.dateRange.endDay,t.dateRange.endHour,t.dateRange.endMinute,t.dateRange.endSecond);if(r>n)throw new Error("Start date must be before or equal to end date");const u=Math.floor((n.getTime()-r.getTime())/1e3)+1,o=s*u,l=new Set(e);let i=0,m=0;const g=Date.now();let R=g;const w=500;for(let p=t.timer0Range.min;p<=t.timer0Range.max&&!d.shouldStop;p++){const T=y.getVCountForTimer0(a,p),h=Math.min(N,u);for(let S=0;S<u&&!d.shouldStop;S+=h){for(;d.isPaused&&!d.shouldStop;)await new Promise(E=>setTimeout(E,100));if(d.shouldStop)break;const A=Math.min(S+h,u),C=r.getTime()+S*1e3,D=r.getTime()+(A-1)*1e3;try{await G(t,C,D,p,p,T,T,l,M=>{m++,postMessage({type:"RESULT",result:M})}),i+=A-S;const E=Date.now();if(E-R>=w||i>=o){R=E;const M=E-g;let W=0;if(i>0&&i<o){const v=M/i,O=o-i;W=Math.round(v*O)}postMessage({type:"PROGRESS",progress:{currentStep:i,totalSteps:o,elapsedTime:M,estimatedTimeRemaining:W,matchesFound:m,currentDateTime:new Date(D).toISOString()}})}}catch(E){console.error("Search batch error:",E)}}}const f=Date.now()-g;d.shouldStop?postMessage({type:"STOPPED",message:`Search stopped. Found ${m} matches out of ${i} tested combinations.`,progress:{currentStep:i,totalSteps:o,elapsedTime:f,estimatedTimeRemaining:0,matchesFound:m}}):postMessage({type:"COMPLETE",message:`Search completed. Found ${m} matches out of ${o} combinations.`,progress:{currentStep:o,totalSteps:o,elapsedTime:f,estimatedTimeRemaining:0,matchesFound:m}})}catch(a){postMessage({type:"ERROR",error:a instanceof Error?a.message:"Unknown error occurred"})}finally{d.isRunning=!1,d.isPaused=!1,d.shouldStop=!1}}self.onmessage=async t=>{const{type:e,conditions:a,targetSeeds:s}=t.data;switch(e){case"START_SEARCH":if(!a||!s){postMessage({type:"ERROR",error:"Missing conditions or target seeds"});return}if(d.isRunning){postMessage({type:"ERROR",error:"Search is already running"});return}d.isRunning=!0,d.isPaused=!1,d.shouldStop=!1,K(a,s);break;case"PAUSE_SEARCH":d.isRunning&&!d.isPaused&&(d.isPaused=!0,postMessage({type:"PAUSED",message:"Search paused"}));break;case"RESUME_SEARCH":d.isRunning&&d.isPaused&&(d.isPaused=!1,postMessage({type:"RESUMED",message:"Search resumed"}));break;case"STOP_SEARCH":d.isRunning&&(d.shouldStop=!0);break;default:postMessage({type:"ERROR",error:`Unknown message type: ${e}`})}};postMessage({type:"READY",message:"Search worker initialized"});
