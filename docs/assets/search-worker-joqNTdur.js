var V=Object.defineProperty;var H=(a,e,t)=>e in a?V(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var _=(a,e,t)=>H(a,typeof e!="symbol"?e+"":e,t);class F{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const t=1732584193,o=4023233417,s=2562383102,u=271733878,r=3285377520,c=new Array(80);for(let m=0;m<16;m++)c[m]=e[m];for(let m=16;m<80;m++)c[m]=this.leftRotate(c[m-3]^c[m-8]^c[m-14]^c[m-16],1);let g=t,n=o,d=s,f=u,h=r;for(let m=0;m<80;m++){let y;m<20?y=this.leftRotate(g,5)+(n&d|~n&f)+h+c[m]+1518500249&4294967295:m<40?y=this.leftRotate(g,5)+(n^d^f)+h+c[m]+1859775393&4294967295:m<60?y=this.leftRotate(g,5)+(n&d|n&f|d&f)+h+c[m]+2400959708&4294967295:y=this.leftRotate(g,5)+(n^d^f)+h+c[m]+3395469782&4294967295,h=f,f=d,d=this.leftRotate(n,30),n=g,g=y}const w=this.add32(t,g),S=this.add32(o,n),p=this.add32(s,d),E=this.add32(u,f),R=this.add32(r,h);return{h0:w,h1:S,h2:p,h3:E,h4:R}}leftRotate(e,t){return(e<<t|e>>>32-t)>>>0}add32(e,t){return(e+t&4294967295)>>>0}static hashToHex(e,t,o,s,u){return e.toString(16).padStart(8,"0")+t.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")+u.toString(16).padStart(8,"0")}}let b=null,z=null;async function O(){return b||z||(z=(async()=>{var a;try{const e=await import("./wasm_pkg-jFzOl2GZ.js");let t;if(typeof process<"u"&&!!((a=process.versions)!=null&&a.node)){const s=await import("./__vite-browser-external-9wXp6ZBx.js"),r=(await import("./__vite-browser-external-9wXp6ZBx.js")).join(process.cwd(),"src/wasm/wasm_pkg_bg.wasm");t={module_or_path:s.readFileSync(r)}}else t={module_or_path:new URL("/pokemon-gen5-initseed/assets/wasm_pkg_bg-DmY2UIoS.wasm",import.meta.url)};return await e.default(t),b={IntegratedSeedSearcher:e.IntegratedSeedSearcher,BWGenerationConfig:e.BWGenerationConfig,PokemonGenerator:e.PokemonGenerator,SeedEnumerator:e.SeedEnumerator,EncounterType:e.EncounterType,GameVersion:e.GameVersion,GameMode:e.GameMode,calculate_game_offset:e.calculate_game_offset},b}catch(e){throw console.error("Failed to load WebAssembly module:",e),b=null,z=null,e}})(),z)}function L(){if(!b)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return b}function U(){return b!==null}const x={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},$={DS:8,DS_LITE:6,"3DS":9};class B{constructor(){_(this,"sha1");_(this,"useWasm",!1);this.sha1=new F}async initializeWasm(){try{return await O(),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&U()}getWasmModule(){return L()}setUseWasm(e){if(e&&!U()){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,t){const o=x[e];if(!o)return console.error(`ROM version not found: ${e}`),null;const s=o[t];return s?{nazo:[...s.nazo],vcountTimerRanges:s.vcountTimerRanges.map(u=>[...u])}:(console.error(`ROM region not found: ${t} for version ${e}`),null)}toLittleEndian32(e){return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){return(e&255)<<8|e>>>8&255}getDayOfWeek(e,t,o){return new Date(e,t-1,o).getDay()}generateMessage(e,t,o,s){const u=this.getROMParameters(e.romVersion,e.romRegion);if(!u)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const r=new Array(16).fill(0);for(let k=0;k<5;k++)r[k]=this.toLittleEndian32(u.nazo[k]);r[5]=this.toLittleEndian32(o<<16|t);const c=e.macAddress[4]<<8|e.macAddress[5];r[6]=c;const g=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,n=100663296,d=$[e.hardware],f=g^n^d;r[7]=this.toLittleEndian32(f);const h=s.getFullYear()%100,w=s.getMonth()+1,S=s.getDate(),p=this.getDayOfWeek(s.getFullYear(),w,S),E=Math.floor(h/10)*16+h%10,R=Math.floor(w/10)*16+w%10,m=Math.floor(S/10)*16+S%10,y=Math.floor(p/10)*16+p%10;r[8]=E<<24|R<<16|m<<8|y;const P=s.getHours(),l=s.getMinutes(),D=s.getSeconds(),M=(e.hardware==="DS"||e.hardware==="DS_LITE")&&P>=12?1:0,v=Math.floor(P/10)*16+P%10,C=Math.floor(l/10)*16+l%10,W=Math.floor(D/10)*16+D%10;return r[9]=M<<30|v<<24|C<<16|W<<8|0,r[10]=0,r[11]=0,r[12]=this.toLittleEndian32(e.keyInput),r[13]=2147483648,r[14]=0,r[15]=416,r}calculateSeed(e){const t=this.sha1.calculateHash(e),o=BigInt(this.toLittleEndian32(t.h0)),g=(BigInt(this.toLittleEndian32(t.h1))<<32n|o)*0x5D588B656C078965n+0x269EC3n;return{seed:Number(g>>32n&0xFFFFFFFFn),hash:F.hashToHex(t.h0,t.h1,t.h2,t.h3,t.h4)}}parseTargetSeeds(e){const t=e.split(`
`).map(r=>r.trim()).filter(r=>r.length>0),o=[],s=[],u=new Set;return t.forEach((r,c)=>{try{let g=r.toLowerCase();if(g.startsWith("0x")&&(g=g.substring(2)),!/^[0-9a-f]{1,8}$/.test(g)){s.push({line:c+1,value:r,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const n=parseInt(g,16);if(u.has(n))return;u.add(n),o.push(n)}catch(g){const n=g instanceof Error?g.message:String(g);s.push({line:c+1,value:r,error:n||"Failed to parse as hexadecimal number."})}}),{validSeeds:o,errors:s}}getVCountForTimer0(e,t){for(const[o,s,u]of e.vcountTimerRanges)if(t>=s&&t<=u)return o;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}function N(a){const e=new Uint8Array(6);for(let t=0;t<6;t++){const o=a[t]??0;let s;if(typeof o=="number")s=o;else{const u=o.trim().toLowerCase();s=u.startsWith("0x")||Number.isNaN(Number(u))?parseInt(u,16):Number(u)}Number.isFinite(s)||(s=0),s=Math.min(255,Math.max(0,Math.trunc(s))),e[t]=s}return e}const G=86400,i={isRunning:!1,isPaused:!1,shouldStop:!1},T={cumulativeRunTime:0,segmentStartTime:0,isPaused:!1};let A;async function Y(){if(!A){A=new B;try{await A.initializeWasm()}catch(a){console.warn("WebAssembly failed in worker, using TypeScript fallback:",a)}}}function K(){T.cumulativeRunTime=0,T.segmentStartTime=Date.now(),T.isPaused=!1}function J(){T.isPaused||(T.cumulativeRunTime+=Date.now()-T.segmentStartTime,T.isPaused=!0)}function q(){T.isPaused&&(T.segmentStartTime=Date.now(),T.isPaused=!1)}function I(){return T.isPaused?T.cumulativeRunTime:T.cumulativeRunTime+(Date.now()-T.segmentStartTime)}async function j(a,e,t,o,s,u,r,c,g){const n=A.getWasmModule();if(n&&n.IntegratedSeedSearcher)try{const d=A.getROMParameters(a.romVersion,a.romRegion);if(!d)throw new Error(`No parameters found for ${a.romVersion} ${a.romRegion}`);const h={DS:8,DS_LITE:6,"3DS":9}[a.hardware]||8,w=new n.IntegratedSeedSearcher(N(a.macAddress),new Uint32Array(d.nazo),a.hardware,a.keyInput,h),S=Math.floor((t-e)/1e3),p=Math.min(1296e3,S);for(let E=0;E<S&&!i.shouldStop;E+=p){if(i.isPaused)for(;i.isPaused&&!i.shouldStop;)await new Promise(l=>setTimeout(l,100));if(i.shouldStop)break;const R=new Date(e+E*1e3),m=new Date(Math.min(e+(E+p)*1e3,t+1e3)),y=Math.floor((m.getTime()-R.getTime())/1e3);if(y<=0)break;if(await new Promise(l=>setTimeout(l,0)),i.isPaused){for(;i.isPaused&&!i.shouldStop;)await new Promise(l=>setTimeout(l,100));if(i.shouldStop)break}const P=w.search_seeds_integrated_simd(R.getFullYear(),R.getMonth()+1,R.getDate(),R.getHours(),R.getMinutes(),R.getSeconds(),y,o,s,u,r,new Uint32Array(Array.from(c)));await new Promise(l=>setTimeout(l,0));for(const l of P){const D=new Date(l.year,l.month-1,l.date,l.hour,l.minute,l.second),M=A.generateMessage(a,l.timer0,l.vcount,D),{hash:v}=A.calculateSeed(M),C={seed:l.seed,datetime:D,timer0:l.timer0,vcount:l.vcount,conditions:a,message:M,sha1Hash:v,isMatch:!0};g(C)}}w.free();return}catch(d){console.error("Integrated search failed, falling back to individual processing:",d)}await Z([e,t],a,o,u,c,A,g)}async function Z(a,e,t,o,s,u,r){const[c,g]=a;let n=0;for(let d=c;d<=g&&!i.shouldStop;d+=1e3){if(n%1e3===0){for(;i.isPaused&&!i.shouldStop;)await new Promise(h=>setTimeout(h,100));await new Promise(h=>setTimeout(h,0))}if(i.shouldStop)break;const f=new Date(d);try{const h=u.generateMessage(e,t,o,f),{seed:w,hash:S}=u.calculateSeed(h);s.has(w)&&r({seed:w,datetime:f,timer0:t,vcount:o,conditions:e,message:h,sha1Hash:S,isMatch:!0})}catch(h){console.error("Error calculating seed:",h)}n++}}async function Q(a,e){try{await Y();const t=A.getROMParameters(a.romVersion,a.romRegion);if(!t)throw new Error(`No parameters found for ${a.romVersion} ${a.romRegion}`);const o=a.timer0VCountConfig.timer0Range.max-a.timer0VCountConfig.timer0Range.min+1,s=new Date(a.dateRange.startYear,a.dateRange.startMonth-1,a.dateRange.startDay,a.dateRange.startHour,a.dateRange.startMinute,a.dateRange.startSecond),u=new Date(a.dateRange.endYear,a.dateRange.endMonth-1,a.dateRange.endDay,a.dateRange.endHour,a.dateRange.endMinute,a.dateRange.endSecond);if(s>u)throw new Error("Start date must be before or equal to end date");const r=Math.floor((u.getTime()-s.getTime())/1e3)+1,c=o*r,g=new Set(e);let n=0,d=0;K();let f=Date.now();const h=500;for(let S=a.timer0VCountConfig.timer0Range.min;S<=a.timer0VCountConfig.timer0Range.max&&!i.shouldStop;S++){const p=A.getVCountForTimer0(t,S);(p<a.timer0VCountConfig.vcountRange.min||p>a.timer0VCountConfig.vcountRange.max)&&console.warn(`[WORKER] Calculated VCount ${p} (0x${p.toString(16)}) is outside user range ${a.timer0VCountConfig.vcountRange.min}-${a.timer0VCountConfig.vcountRange.max}, but continuing search as requested.`);const E=Math.min(G,r);for(let R=0;R<r&&!i.shouldStop;R+=E){for(;i.isPaused&&!i.shouldStop;)await new Promise(l=>setTimeout(l,100));if(i.shouldStop)break;const m=Math.min(R+E,r),y=s.getTime()+R*1e3,P=s.getTime()+(m-1)*1e3;try{await new Promise(M=>setTimeout(M,0)),await j(a,y,P,S,S,p,p,g,M=>{d++,postMessage({type:"RESULT",result:M})}),n+=m-R;const l=Date.now();if(l-f>=h||n>=c){f=l;const M=I();let v=0;if(n>0&&n<c){const C=M/n,W=c-n;v=Math.round(C*W)}postMessage({type:"PROGRESS",progress:{currentStep:n,totalSteps:c,elapsedTime:M,estimatedTimeRemaining:v,matchesFound:d,currentDateTime:new Date(P).toISOString()}})}}catch(l){console.error("Search batch error:",l)}}}const w=I();i.shouldStop?postMessage({type:"STOPPED",message:`Search stopped. Found ${d} matches out of ${n} tested combinations.`,progress:{currentStep:n,totalSteps:c,elapsedTime:w,estimatedTimeRemaining:0,matchesFound:d}}):postMessage({type:"COMPLETE",message:`Search completed. Found ${d} matches out of ${c} combinations.`,progress:{currentStep:n,totalSteps:c,elapsedTime:w,estimatedTimeRemaining:0,matchesFound:d}})}catch(t){postMessage({type:"ERROR",error:t instanceof Error?t.message:"Unknown error occurred"})}finally{i.isRunning=!1,i.isPaused=!1,i.shouldStop=!1}}self.onmessage=async a=>{const{type:e,conditions:t,targetSeeds:o}=a.data;switch(e){case"START_SEARCH":if(!t||!o){postMessage({type:"ERROR",error:"Missing conditions or target seeds"});return}if(i.isRunning){postMessage({type:"ERROR",error:"Search is already running"});return}i.isRunning=!0,i.isPaused=!1,i.shouldStop=!1,Q(t,o);break;case"PAUSE_SEARCH":i.isRunning&&!i.isPaused&&(i.isPaused=!0,J(),postMessage({type:"PAUSED",message:"Search paused"}));break;case"RESUME_SEARCH":i.isRunning&&i.isPaused&&(i.isPaused=!1,q(),postMessage({type:"RESUMED",message:"Search resumed"}));break;case"STOP_SEARCH":i.isRunning&&(i.shouldStop=!0);break;default:postMessage({type:"ERROR",error:`Unknown message type: ${e}`})}};postMessage({type:"READY",message:"Search worker initialized"});
