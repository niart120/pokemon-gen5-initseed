var V=Object.defineProperty;var O=(t,e,r)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var A=(t,e,r)=>O(t,typeof e!="symbol"?e+"":e,r);class P{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const r=1732584193,s=4023233417,o=2562383102,n=271733878,i=3285377520,u=new Array(80);for(let l=0;l<16;l++)u[l]=e[l];for(let l=16;l<80;l++)u[l]=this.leftRotate(u[l-3]^u[l-8]^u[l-14]^u[l-16],1);let c=r,m=s,d=o,g=n,w=i;for(let l=0;l<80;l++){let k;l<20?k=this.leftRotate(c,5)+(m&d|~m&g)+w+u[l]+1518500249&4294967295:l<40?k=this.leftRotate(c,5)+(m^d^g)+w+u[l]+1859775393&4294967295:l<60?k=this.leftRotate(c,5)+(m&d|m&g|d&g)+w+u[l]+2400959708&4294967295:k=this.leftRotate(c,5)+(m^d^g)+w+u[l]+3395469782&4294967295,w=g,g=d,d=this.leftRotate(m,30),m=c,c=k}let R=this.add32(r,c),T=this.add32(s,m),f=this.add32(o,d),S=this.add32(n,g),y=this.add32(i,w);return{h0:R,h1:T,h2:f,h3:S,h4:y}}leftRotate(e,r){return(e<<r|e>>>32-r)>>>0}add32(e,r){return(e+r&4294967295)>>>0}static hashToHex(e,r,s,o,n){return e.toString(16).padStart(8,"0")+r.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+n.toString(16).padStart(8,"0")}}let C=null,M=null;async function F(){return C||M||(M=(async()=>{try{const t=await import("./wasm_pkg-Ra1jWrpZ.js");return await t.default(),C={swap_bytes_32_wasm:t.swap_bytes_32_wasm,swap_bytes_16_wasm:t.swap_bytes_16_wasm,calculate_sha1_hash:t.calculate_sha1_hash,calculate_sha1_batch:t.calculate_sha1_batch,IntegratedSeedSearcher:t.IntegratedSeedSearcher},C}catch(t){throw console.error("Failed to load WebAssembly module:",t),C=null,M=null,t}})(),M)}function L(){if(!C)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return C}class U{constructor(e){A(this,"wasm");this.wasm=e}toLittleEndian32(e){return this.wasm.swap_bytes_32_wasm(e)}toLittleEndian16(e){return this.wasm.swap_bytes_16_wasm(e)}calculateSeed(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words");const r=new Uint32Array(e),s=this.wasm.calculate_sha1_hash(r);if(s.length!==6)throw new Error("WebAssembly returned invalid result");const o=s[0],n=s[1],i=s[2],u=s[3],c=s[4],m=s[5],d=n.toString(16).padStart(8,"0")+i.toString(16).padStart(8,"0")+u.toString(16).padStart(8,"0")+c.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0");return{seed:o,hash:d}}calculateSeedBatch(e){if(e.length===0)return[];for(let n=0;n<e.length;n++)if(e[n].length!==16)throw new Error(`Message ${n} must be exactly 16 32-bit words`);const r=new Uint32Array(e.length*16);for(let n=0;n<e.length;n++)r.set(e[n],n*16);const s=this.wasm.calculate_sha1_batch(r,e.length);if(s.length!==e.length*6)throw new Error("WebAssembly batch calculation failed");const o=[];for(let n=0;n<e.length;n++){const i=s[n*6],u=s[n*6+1],c=s[n*6+2],m=s[n*6+3],d=s[n*6+4],g=s[n*6+5],w=u.toString(16).padStart(8,"0")+c.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0")+d.toString(16).padStart(8,"0")+g.toString(16).padStart(8,"0");o.push({seed:i,hash:w})}return o}}function x(t){return new U(t)}const H={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},$={DS:8,DS_LITE:6,"3DS":9};class B{constructor(){A(this,"sha1");A(this,"wasmCalculator",null);A(this,"useWasm",!1);this.sha1=new P}async initializeWasm(){try{const e=await F();return this.wasmCalculator=x(e),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&this.wasmCalculator!==null}getWasmCalculator(){return this.wasmCalculator}getWasmModule(){return L()}setUseWasm(e){if(e&&!this.wasmCalculator){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,r){const s=H[e];if(!s)return console.error(`ROM version not found: ${e}`),null;const o=s[r];return o?{nazo:[...o.nazo],vcountTimerRanges:o.vcountTimerRanges.map(n=>[...n])}:(console.error(`ROM region not found: ${r} for version ${e}`),null)}toLittleEndian32(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian32(e)}catch(r){console.warn("WebAssembly endian conversion failed, using TypeScript:",r)}return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian16(e)}catch(r){console.warn("WebAssembly endian conversion failed, using TypeScript:",r)}return(e&255)<<8|e>>>8&255}getDayOfWeek(e,r,s){return new Date(e,r-1,s).getDay()}generateMessage(e,r,s,o){const n=this.getROMParameters(e.romVersion,e.romRegion);if(!n)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const i=new Array(16).fill(0);for(let D=0;D<5;D++)i[D]=this.toLittleEndian32(n.nazo[D]);i[5]=this.toLittleEndian32(s<<16|r);const u=e.macAddress[4]<<8|e.macAddress[5];i[6]=u;const c=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,m=100663296,d=$[e.hardware],g=c^m^d;i[7]=this.toLittleEndian32(g);const w=o.getFullYear()%100,R=o.getMonth()+1,T=o.getDate(),f=this.getDayOfWeek(o.getFullYear(),R,T),S=Math.floor(w/10)*16+w%10,y=Math.floor(R/10)*16+R%10,l=Math.floor(T/10)*16+T%10,k=Math.floor(f/10)*16+f%10;i[8]=S<<24|y<<16|l<<8|k;const E=o.getHours(),h=o.getMinutes(),b=o.getSeconds(),I=(e.hardware==="DS"||e.hardware==="DS_LITE")&&E>=12?1:0,W=Math.floor(E/10)*16+E%10,_=Math.floor(h/10)*16+h%10,z=Math.floor(b/10)*16+b%10;return i[9]=I<<30|W<<24|_<<16|z<<8|0,i[10]=0,i[11]=0,i[12]=this.toLittleEndian32(e.keyInput),i[13]=2147483648,i[14]=0,i[15]=416,i}calculateSeed(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.calculateSeed(e)}catch(m){console.warn("WebAssembly calculation failed, falling back to TypeScript:",m)}const r=this.sha1.calculateHash(e),s=BigInt(this.toLittleEndian32(r.h0)),c=(BigInt(this.toLittleEndian32(r.h1))<<32n|s)*0x5D588B656C078965n+0x269EC3n;return{seed:Number(c>>32n&0xFFFFFFFFn),hash:P.hashToHex(r.h0,r.h1,r.h2,r.h3,r.h4)}}parseTargetSeeds(e){const r=e.split(`
`).map(i=>i.trim()).filter(i=>i.length>0),s=[],o=[],n=new Set;return r.forEach((i,u)=>{try{let c=i.toLowerCase();if(c.startsWith("0x")&&(c=c.substring(2)),!/^[0-9a-f]{1,8}$/.test(c)){o.push({line:u+1,value:i,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const m=parseInt(c,16);if(n.has(m))return;n.add(m),s.push(m)}catch{o.push({line:u+1,value:i,error:"Failed to parse as hexadecimal number."})}}),{validSeeds:s,errors:o}}getVCountForTimer0(e,r){for(const[s,o,n]of e.vcountTimerRanges)if(r>=o&&r<=n)return s;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}let a={isRunning:!1,isPaused:!1,shouldStop:!1,workerId:-1,chunk:null,startTime:0},p;async function N(){if(!p){p=new B;try{await p.initializeWasm()}catch(t){console.warn(`Worker ${a.workerId}: WebAssembly failed, using TypeScript fallback:`,t)}}}async function G(t,e){if(!a.chunk)throw new Error("No chunk assigned to worker");a.startTime=Date.now();let r=0;try{if(p.isUsingWasm()){const s=await J(t,e);r=s.length;for(const o of s)postMessage({type:"RESULT",workerId:a.workerId,result:{...o,datetime:o.datetime.toISOString()}})}else r=await K(t,e);postMessage({type:"COMPLETE",workerId:a.workerId,message:`Worker ${a.workerId} completed with ${r} matches`})}catch(s){console.error(`‚ùå Worker ${a.workerId}: Processing error:`,s),postMessage({type:"ERROR",workerId:a.workerId,error:s instanceof Error?s.message:"Unknown error"})}}async function J(t,e){const r=p.getWasmModule(),s=p.getROMParameters(t.romVersion,t.romRegion);if(!s)throw new Error(`No ROM parameters found for ${t.romVersion} ${t.romRegion}`);const n={DS:8,DS_LITE:6,"3DS":9}[t.hardware]||8,i=new r.IntegratedSeedSearcher(t.macAddress,new Uint32Array(s.nazo),t.hardware,t.keyInput,n);try{const u=a.chunk,c=u.startDateTime,m=u.endDateTime,d=Math.floor((m.getTime()-c.getTime())/1e3)+1,g=d*(t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1)*(t.timer0VCountConfig.vcountRange.max-t.timer0VCountConfig.vcountRange.min+1);v(0,g,0);const w=Math.min(7200*60,d),R=[];let T=0;for(let f=0;f<d&&!a.shouldStop;f+=w){if(a.isPaused){for(postMessage({type:"PAUSED",workerId:a.workerId});a.isPaused&&!a.shouldStop;)await new Promise(h=>setTimeout(h,100));a.shouldStop||postMessage({type:"RESUMED",workerId:a.workerId})}if(a.shouldStop)break;const S=new Date(c.getTime()+f*1e3),y=new Date(Math.min(c.getTime()+(f+w)*1e3,m.getTime()+1e3)),l=Math.floor((y.getTime()-S.getTime())/1e3);if(l<=0)break;if(await new Promise(h=>setTimeout(h,0)),a.isPaused){for(;a.isPaused&&!a.shouldStop;)await new Promise(h=>setTimeout(h,100));if(a.shouldStop)break}const k=i.search_seeds_integrated(S.getFullYear(),S.getMonth()+1,S.getDate(),S.getHours(),S.getMinutes(),S.getSeconds(),l,t.timer0VCountConfig.timer0Range.min,t.timer0VCountConfig.timer0Range.max,t.timer0VCountConfig.vcountRange.min,t.timer0VCountConfig.vcountRange.max,new Uint32Array(e));await new Promise(h=>setTimeout(h,0));for(const h of k){const b=new Date(h.year,h.month-1,h.date,h.hour,h.minute,h.second),I=p.generateMessage(t,h.timer0,h.vcount,b),{hash:W}=p.calculateSeed(I);R.push({seed:h.seed,datetime:b,timer0:h.timer0,vcount:h.vcount,conditions:t,message:I,sha1Hash:W,isMatch:!0})}const E=l*(t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1)*(t.timer0VCountConfig.vcountRange.max-t.timer0VCountConfig.vcountRange.min+1);T+=E,v(T,g,R.length)}return R}finally{i.free()}}async function K(t,e){const r=a.chunk,s=new Set(e);let o=0,n=0;const i=p.getROMParameters(t.romVersion,t.romRegion);if(!i)throw new Error(`No ROM parameters found for ${t.romVersion} ${t.romRegion}`);const u=r.startDateTime.getTime(),c=r.endDateTime.getTime(),d=(Math.floor((c-u)/1e3)+1)*(t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1);for(let g=t.timer0VCountConfig.timer0Range.min;g<=t.timer0VCountConfig.timer0Range.max&&!a.shouldStop;g++){const w=p.getVCountForTimer0(i,g);for(let R=u;R<=c&&!a.shouldStop;R+=1e3){for(;a.isPaused&&!a.shouldStop;)await new Promise(f=>setTimeout(f,100));if(a.shouldStop)break;const T=new Date(R);try{const f=p.generateMessage(t,g,w,T),{seed:S,hash:y}=p.calculateSeed(f);if(s.has(S)){const l={seed:S,datetime:T,timer0:g,vcount:w,conditions:t,message:f,sha1Hash:y,isMatch:!0};postMessage({type:"RESULT",workerId:a.workerId,result:{...l,datetime:l.datetime.toISOString()}}),o++}if(n++,n%1e3===0){if(v(n,d,o),a.isPaused)for(;a.isPaused&&!a.shouldStop;)await new Promise(l=>setTimeout(l,100));await new Promise(l=>setTimeout(l,0))}}catch(f){console.error(`Worker ${a.workerId}: Error calculating seed:`,f)}}}return o}function v(t,e,r){var i;const s=Date.now()-a.startTime,o=t/e,n=o>0?Math.round(s/o*(1-o)):0;postMessage({type:"PROGRESS",workerId:a.workerId,progress:{currentStep:t,totalSteps:e,elapsedTime:s,estimatedTimeRemaining:n,matchesFound:r,currentDateTime:(i=a.chunk)==null?void 0:i.startDateTime.toISOString()}})}self.onmessage=async t=>{const{type:e,conditions:r,targetSeeds:s,workerId:o,chunk:n}=t.data;switch(o!==void 0&&(a.workerId=o),e){case"START_SEARCH":if(!r||!s||!n){postMessage({type:"ERROR",workerId:a.workerId,error:"Missing required parameters for search"});return}a.chunk=n,a.isRunning=!0,a.shouldStop=!1,a.isPaused=!1;try{await N(),await G(r,s)}catch(i){postMessage({type:"ERROR",workerId:a.workerId,error:i instanceof Error?i.message:"Unknown error"})}finally{a.isRunning=!1}break;case"PAUSE_SEARCH":a.isPaused=!0,postMessage({type:"PAUSED",workerId:a.workerId});break;case"RESUME_SEARCH":a.isPaused=!1,postMessage({type:"RESUMED",workerId:a.workerId});break;case"STOP_SEARCH":a.shouldStop=!0,a.isRunning=!1,postMessage({type:"STOPPED",workerId:a.workerId});break;case"PING":postMessage({type:"INITIALIZED",workerId:a.workerId,message:`Pong from worker ${a.workerId}`});break}};postMessage({type:"READY",workerId:a.workerId,message:`Parallel worker ${a.workerId} initialized`});
