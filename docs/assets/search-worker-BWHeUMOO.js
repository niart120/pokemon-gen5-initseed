var V=Object.defineProperty;var U=(t,e,a)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var z=(t,e,a)=>U(t,typeof e!="symbol"?e+"":e,a);class k{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const a=1732584193,s=4023233417,l=2562383102,r=271733878,n=3285377520,h=new Array(80);for(let i=0;i<16;i++)h[i]=e[i];for(let i=16;i<80;i++)h[i]=this.leftRotate(h[i-3]^h[i-8]^h[i-14]^h[i-16],1);let o=a,m=s,u=l,f=r,g=n;for(let i=0;i<80;i++){let R;i<20?R=this.leftRotate(o,5)+(m&u|~m&f)+g+h[i]+1518500249&4294967295:i<40?R=this.leftRotate(o,5)+(m^u^f)+g+h[i]+1859775393&4294967295:i<60?R=this.leftRotate(o,5)+(m&u|m&f|u&f)+g+h[i]+2400959708&4294967295:R=this.leftRotate(o,5)+(m^u^f)+g+h[i]+3395469782&4294967295,g=f,f=u,u=this.leftRotate(m,30),m=o,o=R}let w=this.add32(a,o),E=this.add32(s,m),T=this.add32(l,u),p=this.add32(r,f),S=this.add32(n,g);return{h0:w,h1:E,h2:T,h3:p,h4:S}}leftRotate(e,a){return(e<<a|e>>>32-a)>>>0}add32(e,a){return(e+a&4294967295)>>>0}static hashToHex(e,a,s,l,r){return e.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")+l.toString(16).padStart(8,"0")+r.toString(16).padStart(8,"0")}}let M=null,W=null;async function H(){return M||W||(W=(async()=>{try{const t=await import("./wasm_pkg-9M0mfg86.js");return await t.default(),M={swap_bytes_32_wasm:t.swap_bytes_32_wasm,swap_bytes_16_wasm:t.swap_bytes_16_wasm,calculate_sha1_hash:t.calculate_sha1_hash,calculate_sha1_batch:t.calculate_sha1_batch,IntegratedSeedSearcher:t.IntegratedSeedSearcher},M}catch(t){throw console.error("Failed to load WebAssembly module:",t),M=null,W=null,t}})(),W)}function O(){if(!M)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return M}class I{constructor(e){z(this,"wasm");this.wasm=e}toLittleEndian32(e){return this.wasm.swap_bytes_32_wasm(e)}toLittleEndian16(e){return this.wasm.swap_bytes_16_wasm(e)}calculateSeed(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words");const a=new Uint32Array(e),s=this.wasm.calculate_sha1_hash(a);if(s.length!==6)throw new Error("WebAssembly returned invalid result");const l=s[0],r=s[1],n=s[2],h=s[3],o=s[4],m=s[5],u=r.toString(16).padStart(8,"0")+n.toString(16).padStart(8,"0")+h.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0");return{seed:l,hash:u}}calculateSeedBatch(e){if(e.length===0)return[];for(let r=0;r<e.length;r++)if(e[r].length!==16)throw new Error(`Message ${r} must be exactly 16 32-bit words`);const a=new Uint32Array(e.length*16);for(let r=0;r<e.length;r++)a.set(e[r],r*16);const s=this.wasm.calculate_sha1_batch(a,e.length);if(s.length!==e.length*6)throw new Error("WebAssembly batch calculation failed");const l=[];for(let r=0;r<e.length;r++){const n=s[r*6],h=s[r*6+1],o=s[r*6+2],m=s[r*6+3],u=s[r*6+4],f=s[r*6+5],g=h.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0")+u.toString(16).padStart(8,"0")+f.toString(16).padStart(8,"0");l.push({seed:n,hash:g})}return l}}function L(t){return new I(t)}const x={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},$={DS:8,DS_LITE:6,"3DS":9};class B{constructor(){z(this,"sha1");z(this,"wasmCalculator",null);z(this,"useWasm",!1);this.sha1=new k}async initializeWasm(){try{const e=await H();return this.wasmCalculator=L(e),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&this.wasmCalculator!==null}getWasmCalculator(){return this.wasmCalculator}getWasmModule(){return O()}setUseWasm(e){if(e&&!this.wasmCalculator){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,a){const s=x[e];if(!s)return console.error(`ROM version not found: ${e}`),null;const l=s[a];return l?{nazo:[...l.nazo],vcountTimerRanges:l.vcountTimerRanges.map(r=>[...r])}:(console.error(`ROM region not found: ${a} for version ${e}`),null)}toLittleEndian32(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian32(e)}catch(a){console.warn("WebAssembly endian conversion failed, using TypeScript:",a)}return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian16(e)}catch(a){console.warn("WebAssembly endian conversion failed, using TypeScript:",a)}return(e&255)<<8|e>>>8&255}getDayOfWeek(e,a,s){return new Date(e,a-1,s).getDay()}generateMessage(e,a,s,l){const r=this.getROMParameters(e.romVersion,e.romRegion);if(!r)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const n=new Array(16).fill(0);for(let _=0;_<5;_++)n[_]=this.toLittleEndian32(r.nazo[_]);n[5]=this.toLittleEndian32(s<<16|a);const h=e.macAddress[4]<<8|e.macAddress[5];n[6]=h;const o=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,m=100663296,u=$[e.hardware],f=o^m^u;n[7]=this.toLittleEndian32(f);const g=l.getFullYear()%100,w=l.getMonth()+1,E=l.getDate(),T=this.getDayOfWeek(l.getFullYear(),w,E),p=Math.floor(g/10)*16+g%10,S=Math.floor(w/10)*16+w%10,i=Math.floor(E/10)*16+E%10,R=Math.floor(T/10)*16+T%10;n[8]=p<<24|S<<16|i<<8|R;const A=l.getHours(),D=l.getMinutes(),d=l.getSeconds(),y=(e.hardware==="DS"||e.hardware==="DS_LITE")&&A>=12?1:0,P=Math.floor(A/10)*16+A%10,b=Math.floor(D/10)*16+D%10,v=Math.floor(d/10)*16+d%10;return n[9]=y<<30|P<<24|b<<16|v<<8|0,n[10]=0,n[11]=0,n[12]=this.toLittleEndian32(e.keyInput),n[13]=2147483648,n[14]=0,n[15]=416,n}calculateSeed(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.calculateSeed(e)}catch(m){console.warn("WebAssembly calculation failed, falling back to TypeScript:",m)}const a=this.sha1.calculateHash(e),s=BigInt(this.toLittleEndian32(a.h0)),o=(BigInt(this.toLittleEndian32(a.h1))<<32n|s)*0x5D588B656C078965n+0x269EC3n;return{seed:Number(o>>32n&0xFFFFFFFFn),hash:k.hashToHex(a.h0,a.h1,a.h2,a.h3,a.h4)}}parseTargetSeeds(e){const a=e.split(`
`).map(n=>n.trim()).filter(n=>n.length>0),s=[],l=[],r=new Set;return a.forEach((n,h)=>{try{let o=n.toLowerCase();if(o.startsWith("0x")&&(o=o.substring(2)),!/^[0-9a-f]{1,8}$/.test(o)){l.push({line:h+1,value:n,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const m=parseInt(o,16);if(r.has(m))return;r.add(m),s.push(m)}catch{l.push({line:h+1,value:n,error:"Failed to parse as hexadecimal number."})}}),{validSeeds:s,errors:l}}getVCountForTimer0(e,a){for(const[s,l,r]of e.vcountTimerRanges)if(a>=l&&a<=r)return s;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}const N=86400;let c={isRunning:!1,isPaused:!1,shouldStop:!1},C;async function Y(){if(!C){C=new B;try{await C.initializeWasm()}catch(t){console.warn("WebAssembly failed in worker, using TypeScript fallback:",t)}}}async function G(t,e,a,s,l,r,n,h,o){const m=C.getWasmModule();if(m&&m.IntegratedSeedSearcher)try{const u=C.getROMParameters(t.romVersion,t.romRegion);if(!u)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const g={DS:8,DS_LITE:6,"3DS":9}[t.hardware]||8,w=new m.IntegratedSeedSearcher(t.macAddress,new Uint32Array(u.nazo),t.hardware,t.keyInput,g),E=new Date(e),T=Math.floor((a-e)/1e3),p=Math.min(1296e3,T);for(let S=0;S<T&&!c.shouldStop;S+=p){if(c.isPaused)for(;c.isPaused&&!c.shouldStop;)await new Promise(d=>setTimeout(d,100));if(c.shouldStop)break;const i=new Date(e+S*1e3),R=new Date(Math.min(e+(S+p)*1e3,a+1e3)),A=Math.floor((R.getTime()-i.getTime())/1e3);if(A<=0)break;if(await new Promise(d=>setTimeout(d,0)),c.isPaused){for(;c.isPaused&&!c.shouldStop;)await new Promise(d=>setTimeout(d,100));if(c.shouldStop)break}const D=w.search_seeds_integrated(i.getFullYear(),i.getMonth()+1,i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),A,s,l,r,n,new Uint32Array(Array.from(h)));await new Promise(d=>setTimeout(d,0));for(const d of D){const y=new Date(d.year,d.month-1,d.date,d.hour,d.minute,d.second),P=C.generateMessage(t,d.timer0,d.vcount,y),{hash:b}=C.calculateSeed(P),v={seed:d.seed,datetime:y,timer0:d.timer0,vcount:d.vcount,conditions:t,message:P,sha1Hash:b,isMatch:!0};o(v)}}w.free();return}catch(u){console.error("Integrated search failed, falling back to individual processing:",u)}await K([e,a],t,s,r,h,C,o)}async function K(t,e,a,s,l,r,n){const[h,o]=t;let m=0;for(let u=h;u<=o&&!c.shouldStop;u+=1e3){if(m%1e3===0){for(;c.isPaused&&!c.shouldStop;)await new Promise(g=>setTimeout(g,100));await new Promise(g=>setTimeout(g,0))}if(c.shouldStop)break;const f=new Date(u);try{const g=r.generateMessage(e,a,s,f),{seed:w,hash:E}=r.calculateSeed(g);l.has(w)&&n({seed:w,datetime:f,timer0:a,vcount:s,conditions:e,message:g,sha1Hash:E,isMatch:!0})}catch(g){console.error("Error calculating seed:",g)}m++}}async function J(t,e){try{await Y();const a=C.getROMParameters(t.romVersion,t.romRegion);if(!a)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const s=t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1,l=t.timer0VCountConfig.vcountRange.max-t.timer0VCountConfig.vcountRange.min+1,r=new Date(t.dateRange.startYear,t.dateRange.startMonth-1,t.dateRange.startDay,t.dateRange.startHour,t.dateRange.startMinute,t.dateRange.startSecond),n=new Date(t.dateRange.endYear,t.dateRange.endMonth-1,t.dateRange.endDay,t.dateRange.endHour,t.dateRange.endMinute,t.dateRange.endSecond);if(r>n)throw new Error("Start date must be before or equal to end date");const h=Math.floor((n.getTime()-r.getTime())/1e3)+1,o=s*h,m=new Set(e);let u=0,f=0;const g=Date.now();let w=g;const E=500;for(let p=t.timer0VCountConfig.timer0Range.min;p<=t.timer0VCountConfig.timer0Range.max&&!c.shouldStop;p++){const S=C.getVCountForTimer0(a,p);(S<t.timer0VCountConfig.vcountRange.min||S>t.timer0VCountConfig.vcountRange.max)&&console.log(`ℹ️ [WORKER] Calculated VCount ${S} (0x${S.toString(16)}) is outside user range ${t.timer0VCountConfig.vcountRange.min}-${t.timer0VCountConfig.vcountRange.max}, but continuing search as requested.`);const i=Math.min(N,h);for(let R=0;R<h&&!c.shouldStop;R+=i){for(;c.isPaused&&!c.shouldStop;)await new Promise(y=>setTimeout(y,100));if(c.shouldStop)break;const A=Math.min(R+i,h),D=r.getTime()+R*1e3,d=r.getTime()+(A-1)*1e3;try{await new Promise(b=>setTimeout(b,0)),await G(t,D,d,p,p,S,S,m,b=>{f++,postMessage({type:"RESULT",result:b})}),u+=A-R;const y=Date.now();if(y-w>=E||u>=o){w=y;const b=y-g;let v=0;if(u>0&&u<o){const _=b/u,F=o-u;v=Math.round(_*F)}postMessage({type:"PROGRESS",progress:{currentStep:u,totalSteps:o,elapsedTime:b,estimatedTimeRemaining:v,matchesFound:f,currentDateTime:new Date(d).toISOString()}})}}catch(y){console.error("Search batch error:",y)}}}const T=Date.now()-g;c.shouldStop?postMessage({type:"STOPPED",message:`Search stopped. Found ${f} matches out of ${u} tested combinations.`,progress:{currentStep:u,totalSteps:o,elapsedTime:T,estimatedTimeRemaining:0,matchesFound:f}}):postMessage({type:"COMPLETE",message:`Search completed. Found ${f} matches out of ${o} combinations.`,progress:{currentStep:o,totalSteps:o,elapsedTime:T,estimatedTimeRemaining:0,matchesFound:f}})}catch(a){postMessage({type:"ERROR",error:a instanceof Error?a.message:"Unknown error occurred"})}finally{c.isRunning=!1,c.isPaused=!1,c.shouldStop=!1}}self.onmessage=async t=>{const{type:e,conditions:a,targetSeeds:s}=t.data;switch(e){case"START_SEARCH":if(!a||!s){postMessage({type:"ERROR",error:"Missing conditions or target seeds"});return}if(c.isRunning){postMessage({type:"ERROR",error:"Search is already running"});return}c.isRunning=!0,c.isPaused=!1,c.shouldStop=!1,J(a,s);break;case"PAUSE_SEARCH":c.isRunning&&!c.isPaused&&(c.isPaused=!0,postMessage({type:"PAUSED",message:"Search paused"}));break;case"RESUME_SEARCH":c.isRunning&&c.isPaused&&(c.isPaused=!1,postMessage({type:"RESUMED",message:"Search resumed"}));break;case"STOP_SEARCH":c.isRunning&&(c.shouldStop=!0);break;default:postMessage({type:"ERROR",error:`Unknown message type: ${e}`})}};postMessage({type:"READY",message:"Search worker initialized"});
