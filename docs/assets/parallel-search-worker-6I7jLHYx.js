class _{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const a=1732584193,n=4023233417,s=2562383102,o=271733878,c=3285377520,i=new Array(80);for(let u=0;u<16;u++)i[u]=e[u];for(let u=16;u<80;u++)i[u]=this.leftRotate(i[u-3]^i[u-8]^i[u-14]^i[u-16],1);let m=a,g=n,w=s,f=o,h=c;for(let u=0;u<80;u++){let y;u<20?y=this.leftRotate(m,5)+(g&w|~g&f)+h+i[u]+1518500249&4294967295:u<40?y=this.leftRotate(m,5)+(g^w^f)+h+i[u]+1859775393&4294967295:u<60?y=this.leftRotate(m,5)+(g&w|g&f|w&f)+h+i[u]+2400959708&4294967295:y=this.leftRotate(m,5)+(g^w^f)+h+i[u]+3395469782&4294967295,h=f,f=w,w=this.leftRotate(g,30),g=m,m=y}const k=this.add32(a,m),S=this.add32(n,g),p=this.add32(s,w),d=this.add32(o,f),E=this.add32(c,h);return{h0:k,h1:S,h2:p,h3:d,h4:E}}leftRotate(e,a){return(e<<a|e>>>32-a)>>>0}add32(e,a){return(e+a&4294967295)>>>0}static hashToHex(e,a,n,s,o){return e.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+n.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")}}let I=null,D=null;async function L(){return I||D||(D=(async()=>{try{const t=await import("./wasm_pkg-Bq5OCmiP.js");let e;if(typeof process<"u"&&!!process.versions?.node){const n=await import("./__vite-browser-external-9wXp6ZBx.js"),o=(await import("./__vite-browser-external-9wXp6ZBx.js")).join(process.cwd(),"src/wasm/wasm_pkg_bg.wasm");e={module_or_path:n.readFileSync(o)}}else e={module_or_path:new URL("/pokemon-gen5-initseed/assets/wasm_pkg_bg-CeDjJOVY.wasm",import.meta.url)};return await t.default(e),I={IntegratedSeedSearcher:t.IntegratedSeedSearcher,BWGenerationConfig:t.BWGenerationConfig,PokemonGenerator:t.PokemonGenerator,SeedEnumerator:t.SeedEnumerator,EncounterType:t.EncounterType,GameVersion:t.GameVersion,GameMode:t.GameMode,calculate_game_offset:t.calculate_game_offset,sha1_hash_batch:t.sha1_hash_batch},I}catch(t){throw console.error("Failed to load WebAssembly module:",t),I=null,D=null,t}})(),D)}function x(){if(!I)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return I}function V(){return I!==null}const N={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},H=[["A",0],["B",1],["Select",2],["Start",3],["Right",4],["Left",5],["Up",6],["Down",7],["R",8],["L",9],["X",10],["Y",11]];H.reduce((t,[e,a])=>(t[e]=a,t),{});const $=4095,B=12287;function G(t){return Number.isFinite(t)?t&$:0}function O(t){return B^G(t)}const K={DS:8,DS_LITE:6,"3DS":9};class Y{sha1;useWasm=!1;constructor(){this.sha1=new _}async initializeWasm(){try{return await L(),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&V()}getWasmModule(){return x()}setUseWasm(e){if(e&&!V()){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,a){const n=N[e];if(!n)return console.error(`ROM version not found: ${e}`),null;const s=n[a];return s?{nazo:[...s.nazo],vcountTimerRanges:s.vcountTimerRanges.map(o=>[...o])}:(console.error(`ROM region not found: ${a} for version ${e}`),null)}toLittleEndian32(e){return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){return(e&255)<<8|e>>>8&255}getDayOfWeek(e,a,n){return new Date(e,a-1,n).getDay()}generateMessage(e,a,n,s,o){const c=this.getROMParameters(e.romVersion,e.romRegion);if(!c)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const i=new Array(16).fill(0);for(let b=0;b<5;b++)i[b]=this.toLittleEndian32(c.nazo[b]);i[5]=this.toLittleEndian32(n<<16|a);const m=e.macAddress[4]<<8|e.macAddress[5];i[6]=m;const g=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,w=100663296,f=K[e.hardware],h=g^w^f;i[7]=this.toLittleEndian32(h);const k=s.getFullYear()%100,S=s.getMonth()+1,p=s.getDate(),d=this.getDayOfWeek(s.getFullYear(),S,p),E=Math.floor(k/10)*16+k%10,u=Math.floor(S/10)*16+S%10,y=Math.floor(p/10)*16+p%10,C=Math.floor(d/10)*16+d%10;i[8]=E<<24|u<<16|y<<8|C;const M=s.getHours(),l=s.getMinutes(),A=s.getSeconds(),P=(e.hardware==="DS"||e.hardware==="DS_LITE")&&M>=12?1:0,z=Math.floor(M/10)*16+M%10,W=Math.floor(l/10)*16+l%10,F=Math.floor(A/10)*16+A%10;i[9]=P<<30|z<<24|W<<16|F<<8|0,i[10]=0,i[11]=0;const U=o??O(e.keyInput);return i[12]=this.toLittleEndian32(U),i[13]=2147483648,i[14]=0,i[15]=416,i}calculateSeed(e){const a=this.sha1.calculateHash(e),n=BigInt(this.toLittleEndian32(a.h0)),o=BigInt(this.toLittleEndian32(a.h1))<<32n|n,m=o*0x5D588B656C078965n+0x269EC3n;return{seed:Number(m>>32n&0xFFFFFFFFn),hash:_.hashToHex(a.h0,a.h1,a.h2,a.h3,a.h4),lcgSeed:o}}parseTargetSeeds(e){const a=e.split(`
`).map(c=>c.trim()).filter(c=>c.length>0),n=[],s=[],o=new Set;return a.forEach((c,i)=>{try{let m=c.toLowerCase();if(m.startsWith("0x")&&(m=m.substring(2)),!/^[0-9a-f]{1,8}$/.test(m)){s.push({line:i+1,value:c,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const g=parseInt(m,16);if(o.has(g))return;o.add(g),n.push(g)}catch(m){const g=m instanceof Error?m.message:String(m);s.push({line:i+1,value:c,error:g||"Failed to parse as hexadecimal number."})}}),{validSeeds:n,errors:s}}getVCountForTimer0(e,a){for(const[n,s,o]of e.vcountTimerRanges)if(a>=s&&a<=o)return n;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}function J(t){const e=new Uint8Array(6);for(let a=0;a<6;a++){const n=t[a]??0;let s;if(typeof n=="number")s=n;else{const o=n.trim().toLowerCase();s=o.startsWith("0x")||Number.isNaN(Number(o))?parseInt(o,16):Number(o)}Number.isFinite(s)||(s=0),s=Math.min(255,Math.max(0,Math.trunc(s))),e[a]=s}return e}const r={isRunning:!1,isPaused:!1,shouldStop:!1,workerId:-1,chunk:null,startTime:0},R={cumulativeRunTime:0,segmentStartTime:0,isPaused:!1};let T;function j(){R.cumulativeRunTime=0,R.segmentStartTime=Date.now(),R.isPaused=!1}function q(){R.isPaused||(R.cumulativeRunTime+=Date.now()-R.segmentStartTime,R.isPaused=!0)}function X(){R.isPaused&&(R.segmentStartTime=Date.now(),R.isPaused=!1)}function Z(){return R.isPaused?R.cumulativeRunTime:R.cumulativeRunTime+(Date.now()-R.segmentStartTime)}async function Q(){if(!T){T=new Y;try{await T.initializeWasm()}catch(t){console.warn(`Worker ${r.workerId}: WebAssembly failed, using TypeScript fallback:`,t)}}}async function ee(t,e){if(!r.chunk)throw new Error("No chunk assigned to worker");r.startTime=Date.now();let a=0;try{if(T.isUsingWasm()){const n=await te(t,e);a=n.length;for(const s of n)postMessage({type:"RESULT",workerId:r.workerId,result:{...s,datetime:s.datetime.toISOString()}})}else a=await re(t,e);postMessage({type:"COMPLETE",workerId:r.workerId,message:`Worker ${r.workerId} completed with ${a} matches`})}catch(n){console.error(`âŒ Worker ${r.workerId}: Processing error:`,n),postMessage({type:"ERROR",workerId:r.workerId,error:n instanceof Error?n.message:"Unknown error"})}}async function te(t,e){const a=T.getWasmModule(),n=T.getROMParameters(t.romVersion,t.romRegion);if(!n)throw new Error(`No ROM parameters found for ${t.romVersion} ${t.romRegion}`);const o={DS:8,DS_LITE:6,"3DS":9}[t.hardware]||8,c=new a.IntegratedSeedSearcher(J(t.macAddress),new Uint32Array(n.nazo),t.hardware,t.keyInput,o);try{const i=r.chunk,m=i.startDateTime,g=i.endDateTime,w=Math.floor((g.getTime()-m.getTime())/1e3)+1,f=w*(t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1)*(t.timer0VCountConfig.vcountRange.max-t.timer0VCountConfig.vcountRange.min+1);v(0,f,0);const h=Math.min(7200*60,w),k=[];let S=0;for(let p=0;p<w&&!r.shouldStop;p+=h){if(r.isPaused){for(postMessage({type:"PAUSED",workerId:r.workerId});r.isPaused&&!r.shouldStop;)await new Promise(l=>setTimeout(l,100));r.shouldStop||postMessage({type:"RESUMED",workerId:r.workerId})}if(r.shouldStop)break;const d=new Date(m.getTime()+p*1e3),E=new Date(Math.min(m.getTime()+(p+h)*1e3,g.getTime()+1e3)),u=Math.floor((E.getTime()-d.getTime())/1e3);if(u<=0)break;if(await new Promise(l=>setTimeout(l,0)),r.isPaused){for(;r.isPaused&&!r.shouldStop;)await new Promise(l=>setTimeout(l,100));if(r.shouldStop)break}const y=c.search_seeds_integrated_simd(d.getFullYear(),d.getMonth()+1,d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds(),u,t.timer0VCountConfig.timer0Range.min,t.timer0VCountConfig.timer0Range.max,t.timer0VCountConfig.vcountRange.min,t.timer0VCountConfig.vcountRange.max,new Uint32Array(e));await new Promise(l=>setTimeout(l,0));const C=y;for(const l of C){const A=new Date(l.year,l.month-1,l.date,l.hour,l.minute,l.second),P=T.generateMessage(t,l.timer0,l.vcount,A,l.keyCode),{hash:z,lcgSeed:W}=T.calculateSeed(P);k.push({seed:l.seed,datetime:A,timer0:l.timer0,vcount:l.vcount,keyCode:l.keyCode??null,conditions:t,message:P,sha1Hash:z,lcgSeed:W,isMatch:!0})}const M=u*(t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1)*(t.timer0VCountConfig.vcountRange.max-t.timer0VCountConfig.vcountRange.min+1);S+=M,v(S,f,k.length)}return k}finally{c.free()}}async function re(t,e){const a=r.chunk,n=new Set(e);let s=0,o=0;const c=O(t.keyInput),i=T.getROMParameters(t.romVersion,t.romRegion);if(!i)throw new Error(`No ROM parameters found for ${t.romVersion} ${t.romRegion}`);const m=a.startDateTime.getTime(),g=a.endDateTime.getTime(),f=(Math.floor((g-m)/1e3)+1)*(t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1);for(let h=t.timer0VCountConfig.timer0Range.min;h<=t.timer0VCountConfig.timer0Range.max&&!r.shouldStop;h++){const k=T.getVCountForTimer0(i,h);for(let S=m;S<=g&&!r.shouldStop;S+=1e3){for(;r.isPaused&&!r.shouldStop;)await new Promise(d=>setTimeout(d,100));if(r.shouldStop)break;const p=new Date(S);try{const d=T.generateMessage(t,h,k,p,c),{seed:E,hash:u,lcgSeed:y}=T.calculateSeed(d);if(n.has(E)){const C={seed:E,datetime:p,timer0:h,vcount:k,keyCode:c,conditions:t,message:d,sha1Hash:u,lcgSeed:y,isMatch:!0};postMessage({type:"RESULT",workerId:r.workerId,result:{...C,datetime:C.datetime.toISOString()}}),s++}if(o++,o%1e3===0){if(v(o,f,s),r.isPaused)for(;r.isPaused&&!r.shouldStop;)await new Promise(C=>setTimeout(C,100));await new Promise(C=>setTimeout(C,0))}}catch(d){console.error(`Worker ${r.workerId}: Error calculating seed:`,d)}}}return v(o,f,s),s}function v(t,e,a){const n=Z(),s=t/e,o=s>0?Math.round(n/s*(1-s)):0;postMessage({type:"PROGRESS",workerId:r.workerId,progress:{currentStep:t,totalSteps:e,elapsedTime:n,estimatedTimeRemaining:o,matchesFound:a,currentDateTime:r.chunk?.startDateTime.toISOString()}})}self.onmessage=async t=>{const{type:e,conditions:a,targetSeeds:n,workerId:s,chunk:o}=t.data;switch(s!==void 0&&(r.workerId=s),e){case"START_SEARCH":if(!a||!n||!o){postMessage({type:"ERROR",workerId:r.workerId,error:"Missing required parameters for search"});return}r.chunk=o,r.isRunning=!0,r.shouldStop=!1,r.isPaused=!1,j();try{await Q(),await ee(a,n)}catch(c){postMessage({type:"ERROR",workerId:r.workerId,error:c instanceof Error?c.message:"Unknown error"})}finally{r.isRunning=!1}break;case"PAUSE_SEARCH":r.isPaused=!0,q(),postMessage({type:"PAUSED",workerId:r.workerId});break;case"RESUME_SEARCH":r.isPaused=!1,X(),postMessage({type:"RESUMED",workerId:r.workerId});break;case"STOP_SEARCH":r.shouldStop=!0,r.isRunning=!1,postMessage({type:"STOPPED",workerId:r.workerId});break;case"PING":postMessage({type:"INITIALIZED",workerId:r.workerId,message:`Pong from worker ${r.workerId}`});break}};postMessage({type:"READY",workerId:r.workerId,message:`Parallel worker ${r.workerId} initialized`});
