class V{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const a=1732584193,n=4023233417,s=2562383102,i=271733878,o=3285377520,l=new Array(80);for(let r=0;r<16;r++)l[r]=e[r];for(let r=16;r<80;r++)l[r]=this.leftRotate(l[r-3]^l[r-8]^l[r-14]^l[r-16],1);let m=a,g=n,S=s,d=i,f=o;for(let r=0;r<80;r++){let E;r<20?E=this.leftRotate(m,5)+(g&S|~g&d)+f+l[r]+1518500249&4294967295:r<40?E=this.leftRotate(m,5)+(g^S^d)+f+l[r]+1859775393&4294967295:r<60?E=this.leftRotate(m,5)+(g&S|g&d|S&d)+f+l[r]+2400959708&4294967295:E=this.leftRotate(m,5)+(g^S^d)+f+l[r]+3395469782&4294967295,f=d,d=S,S=this.leftRotate(g,30),g=m,m=E}const p=this.add32(a,m),y=this.add32(n,g),h=this.add32(s,S),w=this.add32(i,d),R=this.add32(o,f);return{h0:p,h1:y,h2:h,h3:w,h4:R}}leftRotate(e,a){return(e<<a|e>>>32-a)>>>0}add32(e,a){return(e+a&4294967295)>>>0}static hashToHex(e,a,n,s,i){return e.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+n.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")+i.toString(16).padStart(8,"0")}}let v=null,W=null;async function L(){return v||W||(W=(async()=>{try{const t=await import("./wasm_pkg-HLQ4E-jy.js");let e;if(typeof process<"u"&&!!process.versions?.node){const n=await import("./__vite-browser-external-9wXp6ZBx.js"),i=(await import("./__vite-browser-external-9wXp6ZBx.js")).join(process.cwd(),"src/wasm/wasm_pkg_bg.wasm");e={module_or_path:n.readFileSync(i)}}else e={module_or_path:new URL("/pokemon-gen5-initseed/assets/wasm_pkg_bg-CDMG1ChF.wasm",import.meta.url)};return await t.default(e),v={IntegratedSeedSearcher:t.IntegratedSeedSearcher,BWGenerationConfig:t.BWGenerationConfig,PokemonGenerator:t.PokemonGenerator,SeedEnumerator:t.SeedEnumerator,EncounterType:t.EncounterType,GameVersion:t.GameVersion,GameMode:t.GameMode,calculate_game_offset:t.calculate_game_offset,sha1_hash_batch:t.sha1_hash_batch},v}catch(t){throw console.error("Failed to load WebAssembly module:",t),v=null,W=null,t}})(),W)}function $(){if(!v)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return v}function U(){return v!==null}const x={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},N={DS:8,DS_LITE:6,"3DS":9};class B{sha1;useWasm=!1;constructor(){this.sha1=new V}async initializeWasm(){try{return await L(),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&U()}getWasmModule(){return $()}setUseWasm(e){if(e&&!U()){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,a){const n=x[e];if(!n)return console.error(`ROM version not found: ${e}`),null;const s=n[a];return s?{nazo:[...s.nazo],vcountTimerRanges:s.vcountTimerRanges.map(i=>[...i])}:(console.error(`ROM region not found: ${a} for version ${e}`),null)}toLittleEndian32(e){return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){return(e&255)<<8|e>>>8&255}getDayOfWeek(e,a,n){return new Date(e,a-1,n).getDay()}generateMessage(e,a,n,s){const i=this.getROMParameters(e.romVersion,e.romRegion);if(!i)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const o=new Array(16).fill(0);for(let C=0;C<5;C++)o[C]=this.toLittleEndian32(i.nazo[C]);o[5]=this.toLittleEndian32(n<<16|a);const l=e.macAddress[4]<<8|e.macAddress[5];o[6]=l;const m=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,g=100663296,S=N[e.hardware],d=m^g^S;o[7]=this.toLittleEndian32(d);const f=s.getFullYear()%100,p=s.getMonth()+1,y=s.getDate(),h=this.getDayOfWeek(s.getFullYear(),p,y),w=Math.floor(f/10)*16+f%10,R=Math.floor(p/10)*16+p%10,r=Math.floor(y/10)*16+y%10,E=Math.floor(h/10)*16+h%10;o[8]=w<<24|R<<16|r<<8|E;const A=s.getHours(),T=s.getMinutes(),c=s.getSeconds(),D=(e.hardware==="DS"||e.hardware==="DS_LITE")&&A>=12?1:0,z=Math.floor(A/10)*16+A%10,_=Math.floor(T/10)*16+T%10,P=Math.floor(c/10)*16+c%10;return o[9]=D<<30|z<<24|_<<16|P<<8|0,o[10]=0,o[11]=0,o[12]=this.toLittleEndian32(e.keyInput),o[13]=2147483648,o[14]=0,o[15]=416,o}calculateSeed(e){const a=this.sha1.calculateHash(e),n=BigInt(this.toLittleEndian32(a.h0)),i=BigInt(this.toLittleEndian32(a.h1))<<32n|n,m=i*0x5D588B656C078965n+0x269EC3n;return{seed:Number(m>>32n&0xFFFFFFFFn),hash:V.hashToHex(a.h0,a.h1,a.h2,a.h3,a.h4),lcgSeed:i}}parseTargetSeeds(e){const a=e.split(`
`).map(o=>o.trim()).filter(o=>o.length>0),n=[],s=[],i=new Set;return a.forEach((o,l)=>{try{let m=o.toLowerCase();if(m.startsWith("0x")&&(m=m.substring(2)),!/^[0-9a-f]{1,8}$/.test(m)){s.push({line:l+1,value:o,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const g=parseInt(m,16);if(i.has(g))return;i.add(g),n.push(g)}catch(m){const g=m instanceof Error?m.message:String(m);s.push({line:l+1,value:o,error:g||"Failed to parse as hexadecimal number."})}}),{validSeeds:n,errors:s}}getVCountForTimer0(e,a){for(const[n,s,i]of e.vcountTimerRanges)if(a>=s&&a<=i)return n;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}function G(t){const e=new Uint8Array(6);for(let a=0;a<6;a++){const n=t[a]??0;let s;if(typeof n=="number")s=n;else{const i=n.trim().toLowerCase();s=i.startsWith("0x")||Number.isNaN(Number(i))?parseInt(i,16):Number(i)}Number.isFinite(s)||(s=0),s=Math.min(255,Math.max(0,Math.trunc(s))),e[a]=s}return e}const Y=86400,u={isRunning:!1,isPaused:!1,shouldStop:!1},M={cumulativeRunTime:0,segmentStartTime:0,isPaused:!1};let b;async function K(){if(!b){b=new B;try{await b.initializeWasm()}catch(t){console.warn("WebAssembly failed in worker, using TypeScript fallback:",t)}}}function J(){M.cumulativeRunTime=0,M.segmentStartTime=Date.now(),M.isPaused=!1}function q(){M.isPaused||(M.cumulativeRunTime+=Date.now()-M.segmentStartTime,M.isPaused=!0)}function j(){M.isPaused&&(M.segmentStartTime=Date.now(),M.isPaused=!1)}function I(){return M.isPaused?M.cumulativeRunTime:M.cumulativeRunTime+(Date.now()-M.segmentStartTime)}async function Z(t,e,a,n,s,i,o,l,m,g){const S=b.getWasmModule();if(S&&S.IntegratedSeedSearcher)try{const d=b.getROMParameters(t.romVersion,t.romRegion);if(!d)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const p={DS:8,DS_LITE:6,"3DS":9}[t.hardware]||8,y=new S.IntegratedSeedSearcher(G(t.macAddress),new Uint32Array(d.nazo),t.hardware,t.keyInput,p),h=Math.floor((a-e)/1e3)+1;if(h<=0)return;const w=Math.min(1296e3,h);for(let R=0;R<h&&!u.shouldStop;R+=w){if(u.isPaused)for(;u.isPaused&&!u.shouldStop;)await new Promise(c=>setTimeout(c,100));if(u.shouldStop)break;const r=new Date(e+R*1e3),E=new Date(Math.min(e+(R+w)*1e3,a+1e3)),A=Math.floor((E.getTime()-r.getTime())/1e3);if(A<=0)break;if(await new Promise(c=>setTimeout(c,0)),u.isPaused){for(;u.isPaused&&!u.shouldStop;)await new Promise(c=>setTimeout(c,100));if(u.shouldStop)break}const T=y.search_seeds_integrated_simd(r.getFullYear(),r.getMonth()+1,r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds(),A,n,s,i,o,m);await new Promise(c=>setTimeout(c,0));for(const c of T){const D=new Date(c.year,c.month-1,c.date,c.hour,c.minute,c.second),z=b.generateMessage(t,c.timer0,c.vcount,D),{hash:_,lcgSeed:P}=b.calculateSeed(z),C={seed:c.seed,datetime:D,timer0:c.timer0,vcount:c.vcount,conditions:t,message:z,sha1Hash:_,lcgSeed:P,isMatch:!0};g(C)}}y.free();return}catch(d){console.error("Integrated search failed, falling back to individual processing:",d)}await Q([e,a],t,n,s,i,o,l,b,g)}async function Q(t,e,a,n,s,i,o,l,m){const[g,S]=t,d=l.getROMParameters(e.romVersion,e.romRegion);if(!d)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);let f=0;for(let p=a;p<=n;p++){const y=l.getVCountForTimer0(d,p);for(let h=g;h<=S&&!u.shouldStop;h+=1e3){if(f%1e3===0){for(;u.isPaused&&!u.shouldStop;)await new Promise(R=>setTimeout(R,100));await new Promise(R=>setTimeout(R,0))}if(u.shouldStop)break;const w=new Date(h);try{const R=l.generateMessage(e,p,y,w),{seed:r,hash:E,lcgSeed:A}=l.calculateSeed(R);o.has(r)&&m({seed:r,datetime:w,timer0:p,vcount:y,conditions:e,message:R,sha1Hash:E,lcgSeed:A,isMatch:!0})}catch(R){console.error("Error calculating seed:",R)}f++}}}async function X(t,e){try{await K();const a=b.getROMParameters(t.romVersion,t.romRegion);if(!a)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const n=t.timer0VCountConfig.timer0Range.min,s=t.timer0VCountConfig.timer0Range.max,i=t.timer0VCountConfig.vcountRange.min,o=t.timer0VCountConfig.vcountRange.max,l=s-n+1,m=o-i+1;if(l<=0)throw new Error("Timer0 range must be at least 1 value");if(m<=0)throw new Error("VCount range must be at least 1 value");const g=new Date(t.dateRange.startYear,t.dateRange.startMonth-1,t.dateRange.startDay,t.dateRange.startHour,t.dateRange.startMinute,t.dateRange.startSecond),S=new Date(t.dateRange.endYear,t.dateRange.endMonth-1,t.dateRange.endDay,t.dateRange.endHour,t.dateRange.endMinute,t.dateRange.endSecond);if(g>S)throw new Error("Start date must be before or equal to end date");const d=Math.floor((S.getTime()-g.getTime())/1e3)+1;if(d<=0)throw new Error("Date range must include at least one second");const f=l*m*d,p=new Set(e),y=new Uint32Array(p.size>0?[...p]:[]);let h=0,w=0;J();let R=Date.now();const r=500;for(let T=n;T<=s;T++){const c=b.getVCountForTimer0(a,T);(c<i||c>o)&&console.warn(`[WORKER] Calculated VCount ${c} (0x${c.toString(16)}) is outside user range ${i}-${o}, but continuing search as requested.`)}const E=Math.min(Y,d);for(let T=0;T<d&&!u.shouldStop;T+=E){for(;u.isPaused&&!u.shouldStop;)await new Promise(P=>setTimeout(P,100));if(u.shouldStop)break;const c=Math.min(T+E,d),D=c-T;if(D<=0)continue;const z=g.getTime()+T*1e3,_=g.getTime()+(c-1)*1e3;try{await new Promise(k=>setTimeout(k,0)),await Z(t,z,_,n,s,i,o,p,y,k=>{w++,postMessage({type:"RESULT",result:k})}),h+=D*l*m;const P=Date.now();if(P-R>=r||h>=f){R=P;const k=I();let F=0;if(h>0&&h<f){const O=k/h,H=f-h;F=Math.round(O*H)}postMessage({type:"PROGRESS",progress:{currentStep:Math.min(h,f),totalSteps:f,elapsedTime:k,estimatedTimeRemaining:F,matchesFound:w,currentDateTime:new Date(_).toISOString()}})}}catch(P){console.error("Search batch error:",P)}}const A=I();u.shouldStop?postMessage({type:"STOPPED",message:`Search stopped. Found ${w} matches out of ${h} tested combinations.`,progress:{currentStep:h,totalSteps:f,elapsedTime:A,estimatedTimeRemaining:0,matchesFound:w}}):postMessage({type:"COMPLETE",message:`Search completed. Found ${w} matches out of ${f} combinations.`,progress:{currentStep:h,totalSteps:f,elapsedTime:A,estimatedTimeRemaining:0,matchesFound:w}})}catch(a){postMessage({type:"ERROR",error:a instanceof Error?a.message:"Unknown error occurred"})}finally{u.isRunning=!1,u.isPaused=!1,u.shouldStop=!1}}self.onmessage=async t=>{const{type:e,conditions:a,targetSeeds:n}=t.data;switch(e){case"START_SEARCH":if(!a||!n){postMessage({type:"ERROR",error:"Missing conditions or target seeds"});return}if(u.isRunning){postMessage({type:"ERROR",error:"Search is already running"});return}u.isRunning=!0,u.isPaused=!1,u.shouldStop=!1,X(a,n);break;case"PAUSE_SEARCH":u.isRunning&&!u.isPaused&&(u.isPaused=!0,q(),postMessage({type:"PAUSED",message:"Search paused"}));break;case"RESUME_SEARCH":u.isRunning&&u.isPaused&&(u.isPaused=!1,j(),postMessage({type:"RESUMED",message:"Search resumed"}));break;case"STOP_SEARCH":u.isRunning&&(u.shouldStop=!0);break;default:postMessage({type:"ERROR",error:`Unknown message type: ${e}`})}};postMessage({type:"READY",message:"Search worker initialized"});
