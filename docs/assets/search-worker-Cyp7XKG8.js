var I=Object.defineProperty;var U=(t,e,a)=>e in t?I(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var F=(t,e,a)=>U(t,typeof e!="symbol"?e+"":e,a);class V{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const a=1732584193,u=4023233417,l=2562383102,m=271733878,n=3285377520,g=new Array(80);for(let r=0;r<16;r++)g[r]=e[r];for(let r=16;r<80;r++)g[r]=this.leftRotate(g[r-3]^g[r-8]^g[r-14]^g[r-16],1);let o=a,d=u,i=l,f=m,h=n;for(let r=0;r<80;r++){let w;r<20?w=this.leftRotate(o,5)+(d&i|~d&f)+h+g[r]+1518500249&4294967295:r<40?w=this.leftRotate(o,5)+(d^i^f)+h+g[r]+1859775393&4294967295:r<60?w=this.leftRotate(o,5)+(d&i|d&f|i&f)+h+g[r]+2400959708&4294967295:w=this.leftRotate(o,5)+(d^i^f)+h+g[r]+3395469782&4294967295,h=f,f=i,i=this.leftRotate(d,30),d=o,o=w}let p=this.add32(a,o),E=this.add32(u,d),R=this.add32(l,i),T=this.add32(m,f),y=this.add32(n,h);return{h0:p,h1:E,h2:R,h3:T,h4:y}}leftRotate(e,a){return(e<<a|e>>>32-a)>>>0}add32(e,a){return(e+a&4294967295)>>>0}static hashToHex(e,a,u,l,m){return e.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+u.toString(16).padStart(8,"0")+l.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0")}}let v=null,k=null;async function L(){return v||k||(k=(async()=>{try{const t=await import("./wasm_pkg-iOL440G_.js");return await t.default(),v={IntegratedSeedSearcher:t.IntegratedSeedSearcher},v}catch(t){throw console.error("Failed to load WebAssembly module:",t),v=null,k=null,t}})(),k)}function $(){if(!v)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return v}function H(){return v!==null}const x={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},_={DS:8,DS_LITE:6,"3DS":9};class B{constructor(){F(this,"sha1");F(this,"useWasm",!1);this.sha1=new V}async initializeWasm(){try{return await L(),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&H()}getWasmModule(){return $()}setUseWasm(e){if(e&&!H()){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,a){const u=x[e];if(!u)return console.error(`ROM version not found: ${e}`),null;const l=u[a];return l?{nazo:[...l.nazo],vcountTimerRanges:l.vcountTimerRanges.map(m=>[...m])}:(console.error(`ROM region not found: ${a} for version ${e}`),null)}toLittleEndian32(e){return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){return(e&255)<<8|e>>>8&255}getDayOfWeek(e,a,u){return new Date(e,a-1,u).getDay()}generateMessage(e,a,u,l){const m=this.getROMParameters(e.romVersion,e.romRegion);if(!m)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const n=new Array(16).fill(0);for(let b=0;b<5;b++)n[b]=this.toLittleEndian32(m.nazo[b]);n[5]=this.toLittleEndian32(u<<16|a);const g=e.macAddress[4]<<8|e.macAddress[5];n[6]=g;const o=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,d=100663296,i=_[e.hardware],f=o^d^i;n[7]=this.toLittleEndian32(f);const h=l.getFullYear()%100,p=l.getMonth()+1,E=l.getDate(),R=this.getDayOfWeek(l.getFullYear(),p,E),T=Math.floor(h/10)*16+h%10,y=Math.floor(p/10)*16+p%10,r=Math.floor(E/10)*16+E%10,w=Math.floor(R/10)*16+R%10;n[8]=T<<24|y<<16|r<<8|w;const D=l.getHours(),P=l.getMinutes(),c=l.getSeconds(),z=(e.hardware==="DS"||e.hardware==="DS_LITE")&&D>=12?1:0,M=Math.floor(D/10)*16+D%10,C=Math.floor(P/10)*16+P%10,W=Math.floor(c/10)*16+c%10;return n[9]=z<<30|M<<24|C<<16|W<<8|0,n[10]=0,n[11]=0,n[12]=this.toLittleEndian32(e.keyInput),n[13]=2147483648,n[14]=0,n[15]=416,n}calculateSeed(e){const a=this.sha1.calculateHash(e),u=BigInt(this.toLittleEndian32(a.h0)),o=(BigInt(this.toLittleEndian32(a.h1))<<32n|u)*0x5D588B656C078965n+0x269EC3n;return{seed:Number(o>>32n&0xFFFFFFFFn),hash:V.hashToHex(a.h0,a.h1,a.h2,a.h3,a.h4)}}parseTargetSeeds(e){const a=e.split(`
`).map(n=>n.trim()).filter(n=>n.length>0),u=[],l=[],m=new Set;return a.forEach((n,g)=>{try{let o=n.toLowerCase();if(o.startsWith("0x")&&(o=o.substring(2)),!/^[0-9a-f]{1,8}$/.test(o)){l.push({line:g+1,value:n,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const d=parseInt(o,16);if(m.has(d))return;m.add(d),u.push(d)}catch{l.push({line:g+1,value:n,error:"Failed to parse as hexadecimal number."})}}),{validSeeds:u,errors:l}}getVCountForTimer0(e,a){for(const[u,l,m]of e.vcountTimerRanges)if(a>=l&&a<=m)return u;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}const N=86400;let s={isRunning:!1,isPaused:!1,shouldStop:!1},S={cumulativeRunTime:0,segmentStartTime:0,isPaused:!1},A;async function Y(){if(!A){A=new B;try{await A.initializeWasm()}catch(t){console.warn("WebAssembly failed in worker, using TypeScript fallback:",t)}}}function G(){S.cumulativeRunTime=0,S.segmentStartTime=Date.now(),S.isPaused=!1}function K(){S.isPaused||(S.cumulativeRunTime+=Date.now()-S.segmentStartTime,S.isPaused=!0)}function J(){S.isPaused&&(S.segmentStartTime=Date.now(),S.isPaused=!1)}function O(){return S.isPaused?S.cumulativeRunTime:S.cumulativeRunTime+(Date.now()-S.segmentStartTime)}async function q(t,e,a,u,l,m,n,g,o){const d=A.getWasmModule();if(d&&d.IntegratedSeedSearcher)try{const i=A.getROMParameters(t.romVersion,t.romRegion);if(!i)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const h={DS:8,DS_LITE:6,"3DS":9}[t.hardware]||8,p=new d.IntegratedSeedSearcher(t.macAddress,new Uint32Array(i.nazo),t.hardware,t.keyInput,h),E=new Date(e),R=Math.floor((a-e)/1e3),T=Math.min(1296e3,R);for(let y=0;y<R&&!s.shouldStop;y+=T){if(s.isPaused)for(;s.isPaused&&!s.shouldStop;)await new Promise(c=>setTimeout(c,100));if(s.shouldStop)break;const r=new Date(e+y*1e3),w=new Date(Math.min(e+(y+T)*1e3,a+1e3)),D=Math.floor((w.getTime()-r.getTime())/1e3);if(D<=0)break;if(await new Promise(c=>setTimeout(c,0)),s.isPaused){for(;s.isPaused&&!s.shouldStop;)await new Promise(c=>setTimeout(c,100));if(s.shouldStop)break}const P=p.search_seeds_integrated_simd(r.getFullYear(),r.getMonth()+1,r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds(),D,u,l,m,n,new Uint32Array(Array.from(g)));await new Promise(c=>setTimeout(c,0));for(const c of P){const z=new Date(c.year,c.month-1,c.date,c.hour,c.minute,c.second),M=A.generateMessage(t,c.timer0,c.vcount,z),{hash:C}=A.calculateSeed(M),W={seed:c.seed,datetime:z,timer0:c.timer0,vcount:c.vcount,conditions:t,message:M,sha1Hash:C,isMatch:!0};o(W)}}p.free();return}catch(i){console.error("Integrated search failed, falling back to individual processing:",i)}await Z([e,a],t,u,m,g,A,o)}async function Z(t,e,a,u,l,m,n){const[g,o]=t;let d=0;for(let i=g;i<=o&&!s.shouldStop;i+=1e3){if(d%1e3===0){for(;s.isPaused&&!s.shouldStop;)await new Promise(h=>setTimeout(h,100));await new Promise(h=>setTimeout(h,0))}if(s.shouldStop)break;const f=new Date(i);try{const h=m.generateMessage(e,a,u,f),{seed:p,hash:E}=m.calculateSeed(h);l.has(p)&&n({seed:p,datetime:f,timer0:a,vcount:u,conditions:e,message:h,sha1Hash:E,isMatch:!0})}catch(h){console.error("Error calculating seed:",h)}d++}}async function j(t,e){try{await Y();const a=A.getROMParameters(t.romVersion,t.romRegion);if(!a)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const u=t.timer0VCountConfig.timer0Range.max-t.timer0VCountConfig.timer0Range.min+1,l=t.timer0VCountConfig.vcountRange.max-t.timer0VCountConfig.vcountRange.min+1,m=new Date(t.dateRange.startYear,t.dateRange.startMonth-1,t.dateRange.startDay,t.dateRange.startHour,t.dateRange.startMinute,t.dateRange.startSecond),n=new Date(t.dateRange.endYear,t.dateRange.endMonth-1,t.dateRange.endDay,t.dateRange.endHour,t.dateRange.endMinute,t.dateRange.endSecond);if(m>n)throw new Error("Start date must be before or equal to end date");const g=Math.floor((n.getTime()-m.getTime())/1e3)+1,o=u*g,d=new Set(e);let i=0,f=0;G();let h=Date.now();const p=500;for(let R=t.timer0VCountConfig.timer0Range.min;R<=t.timer0VCountConfig.timer0Range.max&&!s.shouldStop;R++){const T=A.getVCountForTimer0(a,R);(T<t.timer0VCountConfig.vcountRange.min||T>t.timer0VCountConfig.vcountRange.max)&&console.log(`ℹ️ [WORKER] Calculated VCount ${T} (0x${T.toString(16)}) is outside user range ${t.timer0VCountConfig.vcountRange.min}-${t.timer0VCountConfig.vcountRange.max}, but continuing search as requested.`);const y=Math.min(N,g);for(let r=0;r<g&&!s.shouldStop;r+=y){for(;s.isPaused&&!s.shouldStop;)await new Promise(c=>setTimeout(c,100));if(s.shouldStop)break;const w=Math.min(r+y,g),D=m.getTime()+r*1e3,P=m.getTime()+(w-1)*1e3;try{await new Promise(M=>setTimeout(M,0)),await q(t,D,P,R,R,T,T,d,M=>{f++,postMessage({type:"RESULT",result:M})}),i+=w-r;const c=Date.now();if(c-h>=p||i>=o){h=c;const M=O();let C=0;if(i>0&&i<o){const W=M/i,b=o-i;C=Math.round(W*b)}postMessage({type:"PROGRESS",progress:{currentStep:i,totalSteps:o,elapsedTime:M,estimatedTimeRemaining:C,matchesFound:f,currentDateTime:new Date(P).toISOString()}})}}catch(c){console.error("Search batch error:",c)}}}const E=O();s.shouldStop?postMessage({type:"STOPPED",message:`Search stopped. Found ${f} matches out of ${i} tested combinations.`,progress:{currentStep:i,totalSteps:o,elapsedTime:E,estimatedTimeRemaining:0,matchesFound:f}}):postMessage({type:"COMPLETE",message:`Search completed. Found ${f} matches out of ${o} combinations.`,progress:{currentStep:i,totalSteps:o,elapsedTime:E,estimatedTimeRemaining:0,matchesFound:f}})}catch(a){postMessage({type:"ERROR",error:a instanceof Error?a.message:"Unknown error occurred"})}finally{s.isRunning=!1,s.isPaused=!1,s.shouldStop=!1}}self.onmessage=async t=>{const{type:e,conditions:a,targetSeeds:u}=t.data;switch(e){case"START_SEARCH":if(!a||!u){postMessage({type:"ERROR",error:"Missing conditions or target seeds"});return}if(s.isRunning){postMessage({type:"ERROR",error:"Search is already running"});return}s.isRunning=!0,s.isPaused=!1,s.shouldStop=!1,j(a,u);break;case"PAUSE_SEARCH":s.isRunning&&!s.isPaused&&(s.isPaused=!0,K(),postMessage({type:"PAUSED",message:"Search paused"}));break;case"RESUME_SEARCH":s.isRunning&&s.isPaused&&(s.isPaused=!1,J(),postMessage({type:"RESUMED",message:"Search resumed"}));break;case"STOP_SEARCH":s.isRunning&&(s.shouldStop=!0);break;default:postMessage({type:"ERROR",error:`Unknown message type: ${e}`})}};postMessage({type:"READY",message:"Search worker initialized"});
