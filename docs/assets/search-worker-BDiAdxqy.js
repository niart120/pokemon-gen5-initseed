class I{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const a=1732584193,o=4023233417,r=2562383102,i=271733878,g=3285377520,n=new Array(80);for(let s=0;s<16;s++)n[s]=e[s];for(let s=16;s<80;s++)n[s]=this.leftRotate(n[s-3]^n[s-8]^n[s-14]^n[s-16],1);let c=a,m=o,R=r,d=i,f=g;for(let s=0;s<80;s++){let T;s<20?T=this.leftRotate(c,5)+(m&R|~m&d)+f+n[s]+1518500249&4294967295:s<40?T=this.leftRotate(c,5)+(m^R^d)+f+n[s]+1859775393&4294967295:s<60?T=this.leftRotate(c,5)+(m&R|m&d|R&d)+f+n[s]+2400959708&4294967295:T=this.leftRotate(c,5)+(m^R^d)+f+n[s]+3395469782&4294967295,f=d,d=R,R=this.leftRotate(m,30),m=c,c=T}const M=this.add32(a,c),w=this.add32(o,m),h=this.add32(r,R),S=this.add32(i,d),E=this.add32(g,f);return{h0:M,h1:w,h2:h,h3:S,h4:E}}leftRotate(e,a){return(e<<a|e>>>32-a)>>>0}add32(e,a){return(e+a&4294967295)>>>0}static hashToHex(e,a,o,r,i){return e.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+r.toString(16).padStart(8,"0")+i.toString(16).padStart(8,"0")}}let C=null,W=null;async function N(){return C||W||(W=(async()=>{try{const t=await import("./wasm_pkg-Bq5OCmiP.js");let e;if(typeof process<"u"&&!!process.versions?.node){const o=await import("./__vite-browser-external-9wXp6ZBx.js"),i=(await import("./__vite-browser-external-9wXp6ZBx.js")).join(process.cwd(),"src/wasm/wasm_pkg_bg.wasm");e={module_or_path:o.readFileSync(i)}}else e={module_or_path:new URL("/pokemon-gen5-initseed/assets/wasm_pkg_bg-CeDjJOVY.wasm",import.meta.url)};return await t.default(e),C={IntegratedSeedSearcher:t.IntegratedSeedSearcher,BWGenerationConfig:t.BWGenerationConfig,PokemonGenerator:t.PokemonGenerator,SeedEnumerator:t.SeedEnumerator,EncounterType:t.EncounterType,GameVersion:t.GameVersion,GameMode:t.GameMode,calculate_game_offset:t.calculate_game_offset,sha1_hash_batch:t.sha1_hash_batch},C}catch(t){throw console.error("Failed to load WebAssembly module:",t),C=null,W=null,t}})(),W)}function $(){if(!C)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return C}function V(){return C!==null}const B={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},x=[["A",0],["B",1],["Select",2],["Start",3],["Right",4],["Left",5],["Up",6],["Down",7],["R",8],["L",9],["X",10],["Y",11]];x.reduce((t,[e,a])=>(t[e]=a,t),{});const G=4095,K=12287;function Y(t){return Number.isFinite(t)?t&G:0}function U(t){return K^Y(t)}const J={DS:8,DS_LITE:6,"3DS":9};class j{sha1;useWasm=!1;constructor(){this.sha1=new I}async initializeWasm(){try{return await N(),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&V()}getWasmModule(){return $()}setUseWasm(e){if(e&&!V()){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,a){const o=B[e];if(!o)return console.error(`ROM version not found: ${e}`),null;const r=o[a];return r?{nazo:[...r.nazo],vcountTimerRanges:r.vcountTimerRanges.map(i=>[...i])}:(console.error(`ROM region not found: ${a} for version ${e}`),null)}toLittleEndian32(e){return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){return(e&255)<<8|e>>>8&255}getDayOfWeek(e,a,o){return new Date(e,a-1,o).getDay()}generateMessage(e,a,o,r,i){const g=this.getROMParameters(e.romVersion,e.romRegion);if(!g)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const n=new Array(16).fill(0);for(let k=0;k<5;k++)n[k]=this.toLittleEndian32(g.nazo[k]);n[5]=this.toLittleEndian32(o<<16|a);const c=e.macAddress[4]<<8|e.macAddress[5];n[6]=c;const m=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,R=100663296,d=J[e.hardware],f=m^R^d;n[7]=this.toLittleEndian32(f);const M=r.getFullYear()%100,w=r.getMonth()+1,h=r.getDate(),S=this.getDayOfWeek(r.getFullYear(),w,h),E=Math.floor(M/10)*16+M%10,s=Math.floor(w/10)*16+w%10,T=Math.floor(h/10)*16+h%10,v=Math.floor(S/10)*16+S%10;n[8]=E<<24|s<<16|T<<8|v;const p=r.getHours(),A=r.getMinutes(),l=r.getSeconds(),_=(e.hardware==="DS"||e.hardware==="DS_LITE")&&p>=12?1:0,z=Math.floor(p/10)*16+p%10,b=Math.floor(A/10)*16+A%10,F=Math.floor(l/10)*16+l%10;n[9]=_<<30|z<<24|b<<16|F<<8|0,n[10]=0,n[11]=0;const P=i??U(e.keyInput);return n[12]=this.toLittleEndian32(P),n[13]=2147483648,n[14]=0,n[15]=416,n}calculateSeed(e){const a=this.sha1.calculateHash(e),o=BigInt(this.toLittleEndian32(a.h0)),i=BigInt(this.toLittleEndian32(a.h1))<<32n|o,c=i*0x5D588B656C078965n+0x269EC3n;return{seed:Number(c>>32n&0xFFFFFFFFn),hash:I.hashToHex(a.h0,a.h1,a.h2,a.h3,a.h4),lcgSeed:i}}parseTargetSeeds(e){const a=e.split(`
`).map(g=>g.trim()).filter(g=>g.length>0),o=[],r=[],i=new Set;return a.forEach((g,n)=>{try{let c=g.toLowerCase();if(c.startsWith("0x")&&(c=c.substring(2)),!/^[0-9a-f]{1,8}$/.test(c)){r.push({line:n+1,value:g,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const m=parseInt(c,16);if(i.has(m))return;i.add(m),o.push(m)}catch(c){const m=c instanceof Error?c.message:String(c);r.push({line:n+1,value:g,error:m||"Failed to parse as hexadecimal number."})}}),{validSeeds:o,errors:r}}getVCountForTimer0(e,a){for(const[o,r,i]of e.vcountTimerRanges)if(a>=r&&a<=i)return o;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}function q(t){const e=new Uint8Array(6);for(let a=0;a<6;a++){const o=t[a]??0;let r;if(typeof o=="number")r=o;else{const i=o.trim().toLowerCase();r=i.startsWith("0x")||Number.isNaN(Number(i))?parseInt(i,16):Number(i)}Number.isFinite(r)||(r=0),r=Math.min(255,Math.max(0,Math.trunc(r))),e[a]=r}return e}const X=86400,u={isRunning:!1,isPaused:!1,shouldStop:!1},y={cumulativeRunTime:0,segmentStartTime:0,isPaused:!1};let D;async function Z(){if(!D){D=new j;try{await D.initializeWasm()}catch(t){console.warn("WebAssembly failed in worker, using TypeScript fallback:",t)}}}function Q(){y.cumulativeRunTime=0,y.segmentStartTime=Date.now(),y.isPaused=!1}function ee(){y.isPaused||(y.cumulativeRunTime+=Date.now()-y.segmentStartTime,y.isPaused=!0)}function te(){y.isPaused&&(y.segmentStartTime=Date.now(),y.isPaused=!1)}function O(){return y.isPaused?y.cumulativeRunTime:y.cumulativeRunTime+(Date.now()-y.segmentStartTime)}async function ae(t,e,a,o,r,i,g,n,c,m){const R=D.getWasmModule();if(R&&R.IntegratedSeedSearcher)try{const d=D.getROMParameters(t.romVersion,t.romRegion);if(!d)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const M={DS:8,DS_LITE:6,"3DS":9}[t.hardware]||8,w=new R.IntegratedSeedSearcher(q(t.macAddress),new Uint32Array(d.nazo),t.hardware,t.keyInput,M),h=Math.floor((a-e)/1e3)+1;if(h<=0)return;const S=Math.min(1296e3,h);for(let E=0;E<h&&!u.shouldStop;E+=S){if(u.isPaused)for(;u.isPaused&&!u.shouldStop;)await new Promise(l=>setTimeout(l,100));if(u.shouldStop)break;const s=new Date(e+E*1e3),T=new Date(Math.min(e+(E+S)*1e3,a+1e3)),v=Math.floor((T.getTime()-s.getTime())/1e3);if(v<=0)break;if(await new Promise(l=>setTimeout(l,0)),u.isPaused){for(;u.isPaused&&!u.shouldStop;)await new Promise(l=>setTimeout(l,100));if(u.shouldStop)break}const p=w.search_seeds_integrated_simd(s.getFullYear(),s.getMonth()+1,s.getDate(),s.getHours(),s.getMinutes(),s.getSeconds(),v,o,r,i,g,c);await new Promise(l=>setTimeout(l,0));const A=p;for(const l of A){const _=new Date(l.year,l.month-1,l.date,l.hour,l.minute,l.second),z=D.generateMessage(t,l.timer0,l.vcount,_,l.keyCode),{hash:b,lcgSeed:F}=D.calculateSeed(z),P={seed:l.seed,datetime:_,timer0:l.timer0,vcount:l.vcount,keyCode:l.keyCode??null,conditions:t,message:z,sha1Hash:b,lcgSeed:F,isMatch:!0};m(P)}}w.free();return}catch(d){console.error("Integrated search failed, falling back to individual processing:",d)}await se([e,a],t,o,r,i,g,n,D,m)}async function se(t,e,a,o,r,i,g,n,c){const[m,R]=t,d=n.getROMParameters(e.romVersion,e.romRegion);if(!d)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);let f=0;const M=U(e.keyInput);for(let w=a;w<=o;w++){const h=n.getVCountForTimer0(d,w);for(let S=m;S<=R&&!u.shouldStop;S+=1e3){if(f%1e3===0){for(;u.isPaused&&!u.shouldStop;)await new Promise(s=>setTimeout(s,100));await new Promise(s=>setTimeout(s,0))}if(u.shouldStop)break;const E=new Date(S);try{const s=n.generateMessage(e,w,h,E,M),{seed:T,hash:v,lcgSeed:p}=n.calculateSeed(s);g.has(T)&&c({seed:T,datetime:E,timer0:w,vcount:h,keyCode:M,conditions:e,message:s,sha1Hash:v,lcgSeed:p,isMatch:!0})}catch(s){console.error("Error calculating seed:",s)}f++}}}async function re(t,e){try{await Z();const a=D.getROMParameters(t.romVersion,t.romRegion);if(!a)throw new Error(`No parameters found for ${t.romVersion} ${t.romRegion}`);const o=t.timer0VCountConfig.timer0Range.min,r=t.timer0VCountConfig.timer0Range.max,i=t.timer0VCountConfig.vcountRange.min,g=t.timer0VCountConfig.vcountRange.max,n=r-o+1,c=g-i+1;if(n<=0)throw new Error("Timer0 range must be at least 1 value");if(c<=0)throw new Error("VCount range must be at least 1 value");const m=new Date(t.dateRange.startYear,t.dateRange.startMonth-1,t.dateRange.startDay,t.dateRange.startHour,t.dateRange.startMinute,t.dateRange.startSecond),R=new Date(t.dateRange.endYear,t.dateRange.endMonth-1,t.dateRange.endDay,t.dateRange.endHour,t.dateRange.endMinute,t.dateRange.endSecond);if(m>R)throw new Error("Start date must be before or equal to end date");const d=Math.floor((R.getTime()-m.getTime())/1e3)+1;if(d<=0)throw new Error("Date range must include at least one second");const f=n*c*d,M=new Set(e),w=new Uint32Array(M.size>0?[...M]:[]);let h=0,S=0;Q();let E=Date.now();const s=500;for(let p=o;p<=r;p++){const A=D.getVCountForTimer0(a,p);(A<i||A>g)&&console.warn(`[WORKER] Calculated VCount ${A} (0x${A.toString(16)}) is outside user range ${i}-${g}, but continuing search as requested.`)}const T=Math.min(X,d);for(let p=0;p<d&&!u.shouldStop;p+=T){for(;u.isPaused&&!u.shouldStop;)await new Promise(b=>setTimeout(b,100));if(u.shouldStop)break;const A=Math.min(p+T,d),l=A-p;if(l<=0)continue;const _=m.getTime()+p*1e3,z=m.getTime()+(A-1)*1e3;try{await new Promise(P=>setTimeout(P,0)),await ae(t,_,z,o,r,i,g,M,w,P=>{S++,postMessage({type:"RESULT",result:P})}),h+=l*n*c;const b=Date.now();if(b-E>=s||h>=f){E=b;const P=O();let k=0;if(h>0&&h<f){const H=P/h,L=f-h;k=Math.round(H*L)}postMessage({type:"PROGRESS",progress:{currentStep:Math.min(h,f),totalSteps:f,elapsedTime:P,estimatedTimeRemaining:k,matchesFound:S,currentDateTime:new Date(z).toISOString()}})}}catch(b){console.error("Search batch error:",b)}}const v=O();u.shouldStop?postMessage({type:"STOPPED",message:`Search stopped. Found ${S} matches out of ${h} tested combinations.`,progress:{currentStep:h,totalSteps:f,elapsedTime:v,estimatedTimeRemaining:0,matchesFound:S}}):postMessage({type:"COMPLETE",message:`Search completed. Found ${S} matches out of ${f} combinations.`,progress:{currentStep:h,totalSteps:f,elapsedTime:v,estimatedTimeRemaining:0,matchesFound:S}})}catch(a){postMessage({type:"ERROR",error:a instanceof Error?a.message:"Unknown error occurred"})}finally{u.isRunning=!1,u.isPaused=!1,u.shouldStop=!1}}self.onmessage=async t=>{const{type:e,conditions:a,targetSeeds:o}=t.data;switch(e){case"START_SEARCH":if(!a||!o){postMessage({type:"ERROR",error:"Missing conditions or target seeds"});return}if(u.isRunning){postMessage({type:"ERROR",error:"Search is already running"});return}u.isRunning=!0,u.isPaused=!1,u.shouldStop=!1,re(a,o);break;case"PAUSE_SEARCH":u.isRunning&&!u.isPaused&&(u.isPaused=!0,ee(),postMessage({type:"PAUSED",message:"Search paused"}));break;case"RESUME_SEARCH":u.isRunning&&u.isPaused&&(u.isPaused=!1,te(),postMessage({type:"RESUMED",message:"Search resumed"}));break;case"STOP_SEARCH":u.isRunning&&(u.shouldStop=!0);break;default:postMessage({type:"ERROR",error:`Unknown message type: ${e}`})}};postMessage({type:"READY",message:"Search worker initialized"});
