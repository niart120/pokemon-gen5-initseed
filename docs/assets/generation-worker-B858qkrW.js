const b={Normal:0,Surfing:1,Fishing:2,ShakingGrass:3,DustCloud:4,PokemonShadow:5,SurfingBubble:6,FishingBubble:7,StaticSymbol:10,StaticStarter:11,StaticFossil:12,StaticEvent:13,StaticLegendary:14,Roaming:20},I=["Normal","Surfing","Fishing","ShakingGrass","DustCloud","PokemonShadow","SurfingBubble","FishingBubble","StaticSymbol","StaticLegendary","StaticStarter","StaticFossil","StaticEvent","Roaming"];(()=>{const e={};for(const t of I){const o=b[t];e[o]=t}return e})();const S={wild:"Wild",static:"Static",gift:"Gift (WIP)"},$=["Normal","Surfing","Fishing","ShakingGrass","DustCloud","PokemonShadow","SurfingBubble","FishingBubble"],V=["StaticSymbol","StaticLegendary","StaticStarter","StaticFossil","StaticEvent","Roaming"],W=[{key:"wild",label:S.wild,typeNames:$},{key:"static",label:S.static,typeNames:V},{key:"gift",label:S.gift,typeNames:[],disabled:!0}];(()=>{const e={};for(const t of W)e[t.key]=t;return e})();(()=>{const e={};for(const t of W)for(const o of t.typeNames)e[o]=t.key;return e})();var c=(e=>(e[e.BwNewGameWithSave=0]="BwNewGameWithSave",e[e.BwNewGameNoSave=1]="BwNewGameNoSave",e[e.BwContinue=2]="BwContinue",e[e.Bw2NewGameWithMemoryLinkSave=3]="Bw2NewGameWithMemoryLinkSave",e[e.Bw2NewGameNoMemoryLinkSave=4]="Bw2NewGameNoMemoryLinkSave",e[e.Bw2NewGameNoSave=5]="Bw2NewGameNoSave",e[e.Bw2ContinueWithMemoryLink=6]="Bw2ContinueWithMemoryLink",e[e.Bw2ContinueNoMemoryLink=7]="Bw2ContinueNoMemoryLink",e))(c||{});const U=250;function j(e){const t=[];(e.maxAdvances<1||e.maxAdvances>1e6)&&t.push("maxAdvances out of range"),(e.maxResults<1||e.maxResults>1e5)&&t.push("maxResults out of range"),(e.syncNatureId<0||e.syncNatureId>24)&&t.push("syncNatureId out of range"),(e.tid<0||e.tid>65535)&&t.push("tid out of range"),(e.sid<0||e.sid>65535)&&t.push("sid out of range"),e.baseSeed<0n&&t.push("baseSeed must be non-negative"),e.offset<0n&&t.push("offset must be non-negative"),e.offset>=BigInt(e.maxAdvances)&&t.push("offset must be < maxAdvances"),new Set([0,1,2,3,4,5,6,7,10,11,12,13,14,20]).has(e.encounterType)||t.push("encounterType invalid"),!e.newGame&&!e.withSave&&t.push("withSave must be true when continuing a game"),(e.version==="B"||e.version==="W")&&e.memoryLink&&t.push("memoryLink is only available in BW2"),!e.withSave&&e.memoryLink&&t.push("memoryLink requires a save file");try{C(e)}catch(a){const r=a instanceof Error?a.message:String(a);t.push(r||"invalid game mode")}return t}function C(e){const{version:t,newGame:o,withSave:a,memoryLink:r}=e;if(t==="B"||t==="W"){if(r)throw new Error("BW versions do not support memory link");if(!o&&!a)throw new Error("Continue mode requires an existing save");return o?a?c.BwNewGameWithSave:c.BwNewGameNoSave:c.BwContinue}if(!o){if(!a)throw new Error("Continue mode requires an existing save");return r?c.Bw2ContinueWithMemoryLink:c.Bw2ContinueNoMemoryLink}if(!a){if(r)throw new Error("Memory link requires a save file");return c.Bw2NewGameNoSave}return r?c.Bw2NewGameWithMemoryLinkSave:c.Bw2NewGameNoMemoryLinkSave}function D(e){if(!e)throw new Error("WASM data is null or undefined");const t=e,o=s=>{const i=t[s];if(typeof i>"u")throw new Error(`Missing required property: ${s}`);if(typeof i=="function")try{return i.call(t)}catch(l){throw new Error(`Failed to call getter ${s}: ${l}`)}return i},a=s=>{if(typeof s=="bigint")return s;if(typeof s=="number")return BigInt(Math.trunc(s));if(typeof s=="string")return BigInt(s);if(typeof s=="boolean")return BigInt(s?1:0);throw new Error(`Invalid bigint-like value: ${String(s)}`)},r=s=>{if(typeof s=="number")return s;if(typeof s=="bigint")return Number(s);if(typeof s=="string"){const i=Number(s);if(!Number.isFinite(i))throw new Error(`Invalid number string: ${s}`);return i}if(typeof s=="boolean")return s?1:0;throw new Error(`Invalid number-like value: ${String(s)}`)};try{const s=o("get_seed"),i=o("get_pid"),l=o("get_nature"),m=o("get_sync_applied"),f=o("get_ability_slot"),h=o("get_gender_value"),y=o("get_encounter_slot_value"),F=o("get_encounter_type"),P=o("get_level_rand_value"),O=o("get_shiny_type");return{seed:a(s),pid:r(i),nature:r(l),sync_applied:!!m,ability_slot:r(f),gender_value:r(h),encounter_slot_value:r(y),encounter_type:r(F),level_rand_value:a(P),shiny_type:r(O)}}catch(s){throw new Error(`Failed to adapt WASM UnresolvedPokemonData: ${s}`)}}let d=null,p=null;async function z(){return d||p||(p=(async()=>{try{const e=await import("./wasm_pkg-Bq5OCmiP.js");let t;if(typeof process<"u"&&!!process.versions?.node){const a=await import("./__vite-browser-external-9wXp6ZBx.js"),s=(await import("./__vite-browser-external-9wXp6ZBx.js")).join(process.cwd(),"src/wasm/wasm_pkg_bg.wasm");t={module_or_path:a.readFileSync(s)}}else t={module_or_path:new URL("/pokemon-gen5-initseed/assets/wasm_pkg_bg-CeDjJOVY.wasm",import.meta.url)};return await e.default(t),d={IntegratedSeedSearcher:e.IntegratedSeedSearcher,BWGenerationConfig:e.BWGenerationConfig,PokemonGenerator:e.PokemonGenerator,SeedEnumerator:e.SeedEnumerator,EncounterType:e.EncounterType,GameVersion:e.GameVersion,GameMode:e.GameMode,calculate_game_offset:e.calculate_game_offset,sha1_hash_batch:e.sha1_hash_batch},d}catch(e){throw console.error("Failed to load WebAssembly module:",e),d=null,p=null,e}})(),p)}function A(){if(!d)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return d}function _(){return d!==null}let B=!1;function Y(){if(B)return;if(!_())throw new Error("[GameModeMapping] WASM not initialized. Call initWasm() before using game mode mappings.");const e=A().GameMode,t=c,o=Object.keys(t).filter(r=>Number.isNaN(Number(r))).map(r=>[r,t[r]]),a=[];for(const[r,s]of o){const i=e[r];if(typeof i!="number"){a.push(`${r}: missing in WASM`);continue}i!==s&&a.push(`${r}: domain=${s} wasm=${i}`)}if(a.length)throw new Error(`[GameModeMapping] Value mismatch
`+a.join(`
`));B=!0}function q(e){return Y(),e}const T={StaticLegendary:"StaticSymbol"},N=new Map,v=new Map;let k=!1;function H(){if(k)return;if(!_())throw new Error("[EncounterTypeMapping] WASM not initialized. Call initWasm() before using mapping functions.");const e=A().EncounterType,t=[];N.clear(),v.clear();for(const o of I){const a=b[o],r=T[o]??o,s=e[r];if(typeof s!="number"){t.push(`${o}: missing in WASM`);continue}!T[o]&&a!==s&&t.push(`${o}: domain=${a} wasm=${s}`),N.set(a,s),v.has(s)||v.set(s,b[r])}if(t.length)throw new Error(`[EncounterTypeMapping] Value mismatch
`+t.join(`
`));k=!0}function K(e){H();const t=N.get(e);if(t===void 0)throw new Error(`[EncounterTypeMapping] Unmapped domain value: ${e}`);return t}let M,E;function J(e){switch(e){case"B":return 0;case"W":return 1;case"B2":return 2;case"W2":return 3;default:return 0}}const R=self,u=e=>R.postMessage(e),L=U,X=1e3,Q=()=>({processedAdvances:0,totalAdvances:0,resultsCount:0,elapsedMs:0,throughput:0,throughputRaw:0,throughputEma:0,etaMs:0,status:"idle"}),n={params:null,progress:Q(),startTime:null,intervalId:null,enumerator:null,config:null,emaThroughput:null,pendingResults:[],stopped:!1,batchIndex:0,cumulativeResults:0,shinyFound:!1,baseAdvance:0};u({type:"READY",version:"1"});R.onmessage=e=>{const t=e.data;(async()=>{try{switch(t.type){case"START_GENERATION":await Z(t.params);break;case"PAUSE":ee();break;case"RESUME":te();break;case"STOP":ne();break;default:break}}catch(o){const a=o instanceof Error?o.message:String(o);u({type:"ERROR",message:a,category:"RUNTIME",fatal:!1})}})()};async function Z(e){if(n.progress.status==="running")return;const t=j(e);if(t.length){u({type:"ERROR",message:t.join(", "),category:"VALIDATION",fatal:!1});return}g(),n.params=e,n.startTime=performance.now();const o=Number(e.offset),a=e.maxAdvances-o;if(a<=0){u({type:"ERROR",message:"maxAdvances must be greater than offset",category:"VALIDATION",fatal:!1});return}n.progress={processedAdvances:0,totalAdvances:a,resultsCount:0,elapsedMs:0,throughput:0,throughputRaw:0,throughputEma:0,etaMs:0,status:"running"},n.emaThroughput=null,n.stopped=!1,n.pendingResults=[],n.batchIndex=0,n.cumulativeResults=0,n.shinyFound=!1;try{_()||await z();const r=A();if(M=r.BWGenerationConfig,E=r.SeedEnumerator,!E)throw new Error("SeedEnumerator not exposed");const s=K(e.encounterType);n.config=new M(J(e.version),s,e.tid,e.sid,e.syncEnabled,e.syncNatureId,e.isShinyLocked,e.shinyCharm);const i=C(e),l=q(i),f=BigInt(r.calculate_game_offset(e.baseSeed,l))+e.offset;n.baseAdvance=o,n.enumerator=new E(e.baseSeed,f,a,n.config)}catch(r){const s=r instanceof Error?r.message:String(r);u({type:"ERROR",message:s,category:"WASM_INIT",fatal:!0});return}n.intervalId=setInterval(G,L),u({type:"PROGRESS",payload:{...n.progress}})}function G(){if(!n.params||n.progress.status!=="running"||n.stopped)return;se();const e=n.progress,t=performance.now();if(e.elapsedMs=t-(n.startTime||t),e.elapsedMs>0){const r=e.processedAdvances/(e.elapsedMs/1e3);e.throughputRaw=r;const s=.2;n.emaThroughput=n.emaThroughput==null?r:s*r+(1-s)*n.emaThroughput,e.throughputEma=n.emaThroughput,e.throughput=r}const o=e.totalAdvances-e.processedAdvances,a=e.throughputEma&&e.throughputEma>0?e.throughputEma:e.throughputRaw||0;e.etaMs=a>0?o/a*1e3:0,u({type:"PROGRESS",payload:{...e}}),e.processedAdvances>=e.totalAdvances&&w("max-advances")}function ee(){n.progress.status==="running"&&(n.progress.status="paused",g(),u({type:"PAUSED"}))}function te(){n.progress.status!=="paused"||!n.params||(n.progress.status="running",n.intervalId=setInterval(G,L),u({type:"RESUMED"}))}function ne(){["idle","stopped","completed"].includes(n.progress.status)||(n.stopped=!0,g(),n.progress.status="stopped",u({type:"STOPPED",payload:{reason:"stopped",processedAdvances:n.progress.processedAdvances,resultsCount:n.progress.resultsCount,elapsedMs:n.progress.elapsedMs,shinyFound:!1}}))}function w(e){g(),x(!0),n.progress.status="completed",u({type:"COMPLETE",payload:{reason:e,processedAdvances:n.progress.processedAdvances,resultsCount:n.progress.resultsCount,elapsedMs:n.progress.elapsedMs,shinyFound:n.shinyFound}})}function g(){n.intervalId!=null&&(clearInterval(n.intervalId),n.intervalId=null)}function se(){if(!n.enumerator||!n.params)return;const e=n.params,t=n.progress;let o=X;const a=t.totalAdvances-t.processedAdvances;if(a<=0)return;o>a&&(o=a);let r=0,s=null;for(let i=0;i<o;i++){const l=n.enumerator.next_pokemon();if(!l)break;let m;try{m=D(l)}catch{w("error");return}const f=n.baseAdvance+t.processedAdvances+i,h={...m,advance:f},y=(h.shiny_type??0)!==0;if(y&&!n.shinyFound&&(n.shinyFound=!0),t.resultsCount<e.maxResults&&(n.pendingResults.push(h),t.resultsCount+=1),r++,n.pendingResults.length>=e.batchSize&&x(!1),s||(e.stopAtFirstShiny&&y?s="first-shiny":e.stopOnCap&&t.resultsCount>=e.maxResults&&(s="max-results")),s)break}if(t.processedAdvances+=r,s){w(s);return}t.processedAdvances>=t.totalAdvances&&w("max-advances")}function x(e){if(!n.params||n.pendingResults.length===0||!e&&n.pendingResults.length<n.params.batchSize)return;const t=n.pendingResults.splice(0,n.pendingResults.length);n.batchIndex+=1,n.cumulativeResults+=t.length,u({type:"RESULT_BATCH",payload:{batchIndex:n.batchIndex,batchSize:t.length,results:t,cumulativeResults:n.cumulativeResults}})}R.onclose=()=>g();
