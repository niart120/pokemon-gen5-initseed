var O=Object.defineProperty;var F=(t,e,r)=>e in t?O(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var I=(t,e,r)=>F(t,typeof e!="symbol"?e+"":e,r);class C{calculateHash(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words (64 bytes)");const r=1732584193,a=4023233417,n=2562383102,s=271733878,o=3285377520,u=new Array(80);for(let l=0;l<16;l++)u[l]=e[l];for(let l=16;l<80;l++)u[l]=this.leftRotate(u[l-3]^u[l-8]^u[l-14]^u[l-16],1);let i=r,h=a,g=n,m=s,w=o;for(let l=0;l<80;l++){let d;l<20?d=this.leftRotate(i,5)+(h&g|~h&m)+w+u[l]+1518500249&4294967295:l<40?d=this.leftRotate(i,5)+(h^g^m)+w+u[l]+1859775393&4294967295:l<60?d=this.leftRotate(i,5)+(h&g|h&m|g&m)+w+u[l]+2400959708&4294967295:d=this.leftRotate(i,5)+(h^g^m)+w+u[l]+3395469782&4294967295,w=m,m=g,g=this.leftRotate(h,30),h=i,i=d}let R=this.add32(r,i),f=this.add32(a,h),S=this.add32(n,g),T=this.add32(s,m),k=this.add32(o,w);return{h0:R,h1:f,h2:S,h3:T,h4:k}}leftRotate(e,r){return(e<<r|e>>>32-r)>>>0}add32(e,r){return(e+r&4294967295)>>>0}static hashToHex(e,r,a,n,s){return e.toString(16).padStart(8,"0")+r.toString(16).padStart(8,"0")+a.toString(16).padStart(8,"0")+n.toString(16).padStart(8,"0")+s.toString(16).padStart(8,"0")}}let y=null,M=null;async function x(){return y||M||(M=(async()=>{try{const t=await import("./wasm_pkg-dLjgnl_0.js");return await t.default(),y={swap_bytes_32_wasm:t.swap_bytes_32_wasm,swap_bytes_16_wasm:t.swap_bytes_16_wasm,calculate_sha1_hash:t.calculate_sha1_hash,calculate_sha1_batch:t.calculate_sha1_batch,IntegratedSeedSearcher:t.IntegratedSeedSearcher},y}catch(t){throw console.error("Failed to load WebAssembly module:",t),y=null,M=null,t}})(),M)}function L(){if(!y)throw new Error("WebAssembly module not initialized. Call initWasm() first.");return y}class U{constructor(e){I(this,"wasm");this.wasm=e}toLittleEndian32(e){return this.wasm.swap_bytes_32_wasm(e)}toLittleEndian16(e){return this.wasm.swap_bytes_16_wasm(e)}calculateSeed(e){if(e.length!==16)throw new Error("Message must be exactly 16 32-bit words");const r=new Uint32Array(e),a=this.wasm.calculate_sha1_hash(r);if(a.length!==6)throw new Error("WebAssembly returned invalid result");const n=a[0],s=a[1],o=a[2],u=a[3],i=a[4],h=a[5],g=s.toString(16).padStart(8,"0")+o.toString(16).padStart(8,"0")+u.toString(16).padStart(8,"0")+i.toString(16).padStart(8,"0")+h.toString(16).padStart(8,"0");return{seed:n,hash:g}}calculateSeedBatch(e){if(e.length===0)return[];for(let s=0;s<e.length;s++)if(e[s].length!==16)throw new Error(`Message ${s} must be exactly 16 32-bit words`);const r=new Uint32Array(e.length*16);for(let s=0;s<e.length;s++)r.set(e[s],s*16);const a=this.wasm.calculate_sha1_batch(r,e.length);if(a.length!==e.length*6)throw new Error("WebAssembly batch calculation failed");const n=[];for(let s=0;s<e.length;s++){const o=a[s*6],u=a[s*6+1],i=a[s*6+2],h=a[s*6+3],g=a[s*6+4],m=a[s*6+5],w=u.toString(16).padStart(8,"0")+i.toString(16).padStart(8,"0")+h.toString(16).padStart(8,"0")+g.toString(16).padStart(8,"0")+m.toString(16).padStart(8,"0");n.push({seed:o,hash:w})}return n}}function H(t){return new U(t)}const $={B:{JPN:{nazo:[35741456,35741708,35741708,35741784,35741784],vcountTimerRanges:[[96,3193,3194]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3204,3205]]},USA:{nazo:[35741872,35742124,35742124,35742200,35742200],vcountTimerRanges:[[96,3195,3196]]},GER:{nazo:[35741680,35741932,35741932,35742008,35742008],vcountTimerRanges:[[95,3191,3192]]},FRA:{nazo:[35741744,35741996,35741996,35742072,35742072],vcountTimerRanges:[[95,3187,3188]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[96,3206,3207]]},ITA:{nazo:[35741616,35741868,35741868,35741944,35741944],vcountTimerRanges:[[95,3178,3179]]}},W:{JPN:{nazo:[35741488,35741740,35741740,35741816,35741816],vcountTimerRanges:[[95,3175,3177]]},KOR:{nazo:[35743664,35743916,35743916,35743992,35743992],vcountTimerRanges:[[96,3195,3196]]},USA:{nazo:[35741904,35742156,35742156,35742232,35742232],vcountTimerRanges:[[96,3198,3200]]},GER:{nazo:[35741712,35741964,35741964,35742040,35742040],vcountTimerRanges:[[96,3194,3195]]},FRA:{nazo:[35741776,35742028,35742028,35742104,35742104],vcountTimerRanges:[[95,3182,3183]]},SPA:{nazo:[35741808,35742060,35742060,35742136,35742136],vcountTimerRanges:[[95,3184,3185]]},ITA:{nazo:[35741648,35741900,35741900,35741976,35741976],vcountTimerRanges:[[96,3195,3196]]}},B2:{JPN:{nazo:[34187484,33790665,35649968,35650052,35650052],vcountTimerRanges:[[130,4354,4360]]},KOR:{nazo:[34190860,33793237,35653456,35653540,35653540],vcountTimerRanges:[[130,4335,4340]]},USA:{nazo:[34189032,33791465,35651600,35651684,35651684],vcountTimerRanges:[[130,4354,4360]]},GER:{nazo:[34188840,33791337,35651408,35651492,35651492],vcountTimerRanges:[[129,4325,4328],[130,4329,4332]]},FRA:{nazo:[34189064,33791481,35651632,35651716,35651716],vcountTimerRanges:[[130,4340,4344]]},SPA:{nazo:[34188968,33791417,35651536,35651620,35651620],vcountTimerRanges:[[130,4353,4358]]},ITA:{nazo:[34188776,33791337,35651344,35651428,35651428],vcountTimerRanges:[[130,4359,4361],[131,4361,4365]]}},W2:{JPN:{nazo:[34187516,33790709,3565e4,35650084,35650084],vcountTimerRanges:[[130,4341,4347]]},KOR:{nazo:[34190892,33793281,35653488,35653572,35653572],vcountTimerRanges:[[129,4324,4329]]},USA:{nazo:[34189096,33791509,35651664,35651748,35651748],vcountTimerRanges:[[130,4338,4342]]},GER:{nazo:[34188872,33791381,35651440,35651524,35651524],vcountTimerRanges:[[130,4325,4333]]},FRA:{nazo:[34189096,33791525,35651664,35651748,35651748],vcountTimerRanges:[[130,4332,4336]]},SPA:{nazo:[34189e3,33791461,35651568,35651652,35651652],vcountTimerRanges:[[130,4335,4340]]},ITA:{nazo:[34188840,33791381,35651408,35651492,35651492],vcountTimerRanges:[[130,4351,4356]]}}},B={DS:8,DS_LITE:6,"3DS":9};class V{constructor(){I(this,"sha1");I(this,"wasmCalculator",null);I(this,"useWasm",!1);this.sha1=new C}async initializeWasm(){try{const e=await x();return this.wasmCalculator=H(e),this.useWasm=!0,!0}catch(e){return console.warn("WebAssembly initialization failed, falling back to TypeScript:",e),this.useWasm=!1,!1}}isUsingWasm(){return this.useWasm&&this.wasmCalculator!==null}getWasmCalculator(){return this.wasmCalculator}getWasmModule(){return L()}setUseWasm(e){if(e&&!this.wasmCalculator){console.warn("Cannot enable WebAssembly: module not initialized");return}this.useWasm=e}getROMParameters(e,r){const a=$[e];if(!a)return console.error(`ROM version not found: ${e}`),null;const n=a[r];return n?{nazo:[...n.nazo],vcountTimerRanges:n.vcountTimerRanges.map(s=>[...s])}:(console.error(`ROM region not found: ${r} for version ${e}`),null)}toLittleEndian32(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian32(e)}catch(r){console.warn("WebAssembly endian conversion failed, using TypeScript:",r)}return((e&255)<<24|(e>>>8&255)<<16|(e>>>16&255)<<8|e>>>24&255)>>>0}toLittleEndian16(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.toLittleEndian16(e)}catch(r){console.warn("WebAssembly endian conversion failed, using TypeScript:",r)}return(e&255)<<8|e>>>8&255}getDayOfWeek(e,r,a){return new Date(e,r-1,a).getDay()}generateMessage(e,r,a,n){const s=this.getROMParameters(e.romVersion,e.romRegion);if(!s)throw new Error(`No parameters found for ${e.romVersion} ${e.romRegion}`);const o=new Array(16).fill(0);for(let v=0;v<5;v++)o[v]=this.toLittleEndian32(s.nazo[v]);o[5]=this.toLittleEndian32(a<<16|r);const u=e.macAddress[4]<<8|e.macAddress[5];o[6]=u;const i=e.macAddress[0]<<0|e.macAddress[1]<<8|e.macAddress[2]<<16|e.macAddress[3]<<24,h=100663296,g=B[e.hardware],m=i^h^g;o[7]=this.toLittleEndian32(m);const w=n.getFullYear()%100,R=n.getMonth()+1,f=n.getDate(),S=this.getDayOfWeek(n.getFullYear(),R,f),T=Math.floor(w/10)*16+w%10,k=Math.floor(R/10)*16+R%10,l=Math.floor(f/10)*16+f%10,d=Math.floor(S/10)*16+S%10;o[8]=T<<24|k<<16|l<<8|d;const b=n.getHours(),E=n.getMinutes(),A=n.getSeconds(),D=(e.hardware==="DS"||e.hardware==="DS_LITE")&&b>=12?1:0,_=Math.floor(b/10)*16+b%10,z=Math.floor(E/10)*16+E%10,P=Math.floor(A/10)*16+A%10;return o[9]=D<<30|_<<24|z<<16|P<<8|0,o[10]=0,o[11]=0,o[12]=this.toLittleEndian32(e.keyInput),o[13]=2147483648,o[14]=0,o[15]=416,o}calculateSeed(e){if(this.useWasm&&this.wasmCalculator)try{return this.wasmCalculator.calculateSeed(e)}catch(h){console.warn("WebAssembly calculation failed, falling back to TypeScript:",h)}const r=this.sha1.calculateHash(e),a=BigInt(this.toLittleEndian32(r.h0)),i=(BigInt(this.toLittleEndian32(r.h1))<<32n|a)*0x5D588B656C078965n+0x269EC3n;return{seed:Number(i>>32n&0xFFFFFFFFn),hash:C.hashToHex(r.h0,r.h1,r.h2,r.h3,r.h4)}}parseTargetSeeds(e){const r=e.split(`
`).map(o=>o.trim()).filter(o=>o.length>0),a=[],n=[],s=new Set;return r.forEach((o,u)=>{try{let i=o.toLowerCase();if(i.startsWith("0x")&&(i=i.substring(2)),!/^[0-9a-f]{1,8}$/.test(i)){n.push({line:u+1,value:o,error:"Invalid hexadecimal format. Expected 1-8 hex digits."});return}const h=parseInt(i,16);if(s.has(h))return;s.add(h),a.push(h)}catch{n.push({line:u+1,value:o,error:"Failed to parse as hexadecimal number."})}}),{validSeeds:a,errors:n}}getVCountForTimer0(e,r){for(const[a,n,s]of e.vcountTimerRanges)if(r>=n&&r<=s)return a;return e.vcountTimerRanges.length>0?e.vcountTimerRanges[0][0]:96}}let c={isRunning:!1,isPaused:!1,shouldStop:!1,workerId:-1,chunk:null,startTime:0},p;async function N(){if(!p){p=new V;try{await p.initializeWasm()}catch(t){console.warn(`Worker ${c.workerId}: WebAssembly failed, using TypeScript fallback:`,t)}}}async function G(t,e){if(!c.chunk)throw new Error("No chunk assigned to worker");c.startTime=Date.now();let r=0;try{if(p.isUsingWasm()){const a=await J(t,e);r=a.length;for(const n of a)postMessage({type:"RESULT",workerId:c.workerId,result:{...n,datetime:n.datetime.toISOString()}})}else r=await K(t,e);postMessage({type:"COMPLETE",workerId:c.workerId,message:`Worker ${c.workerId} completed with ${r} matches`})}catch(a){console.error(`‚ùå Worker ${c.workerId}: Processing error:`,a),postMessage({type:"ERROR",workerId:c.workerId,error:a instanceof Error?a.message:"Unknown error"})}}async function J(t,e){const r=p.getWasmModule(),a=p.getROMParameters(t.romVersion,t.romRegion);if(!a)throw new Error(`No ROM parameters found for ${t.romVersion} ${t.romRegion}`);const n=new r.IntegratedSeedSearcher(t.macAddress,new Uint32Array(a.nazo),t.hardware,t.keyInput,5,8);try{const s=c.chunk,o=s.startDateTime,u=s.endDateTime,i=Math.floor((u.getTime()-o.getTime())/1e3)+1,h=i*(t.timer0Range.max-t.timer0Range.min+1)*(t.vcountRange.max-t.vcountRange.min+1);W(0,h,0);const g=Math.min(720*60*60,i),m=[];let w=0;for(let R=0;R<i;R+=g){const f=new Date(o.getTime()+R*1e3),S=new Date(Math.min(o.getTime()+(R+g)*1e3,u.getTime()+1e3)),T=Math.floor((S.getTime()-f.getTime())/1e3);if(T<=0)break;const k=n.search_seeds_integrated(f.getFullYear(),f.getMonth()+1,f.getDate(),f.getHours(),f.getMinutes(),f.getSeconds(),T,t.timer0Range.min,t.timer0Range.max,t.vcountRange.min,t.vcountRange.max,new Uint32Array(e));for(const d of k){const b=new Date(d.year,d.month-1,d.date,d.hour,d.minute,d.second),E=p.generateMessage(t,d.timer0,d.vcount,b),{hash:A}=p.calculateSeed(E);m.push({seed:d.seed,datetime:b,timer0:d.timer0,vcount:d.vcount,conditions:t,message:E,sha1Hash:A,isMatch:!0})}const l=T*(t.timer0Range.max-t.timer0Range.min+1)*(t.vcountRange.max-t.vcountRange.min+1);w+=l,W(w,h,m.length)}return m}finally{n.free()}}async function K(t,e){const r=c.chunk,a=new Set(e);let n=0,s=0;const o=p.getROMParameters(t.romVersion,t.romRegion);if(!o)throw new Error(`No ROM parameters found for ${t.romVersion} ${t.romRegion}`);const u=r.startDateTime.getTime(),i=r.endDateTime.getTime(),g=(Math.floor((i-u)/1e3)+1)*(t.timer0Range.max-t.timer0Range.min+1);for(let m=t.timer0Range.min;m<=t.timer0Range.max&&!c.shouldStop;m++){const w=p.getVCountForTimer0(o,m);for(let R=u;R<=i&&!c.shouldStop;R+=1e3){for(;c.isPaused&&!c.shouldStop;)await new Promise(S=>setTimeout(S,100));if(c.shouldStop)break;const f=new Date(R);try{const S=p.generateMessage(t,m,w,f),{seed:T,hash:k}=p.calculateSeed(S);if(a.has(T)){const l={seed:T,datetime:f,timer0:m,vcount:w,conditions:t,message:S,sha1Hash:k,isMatch:!0};postMessage({type:"RESULT",workerId:c.workerId,result:{...l,datetime:l.datetime.toISOString()}}),n++}s++,s%1e3===0&&W(s,g,n)}catch(S){console.error(`Worker ${c.workerId}: Error calculating seed:`,S)}}}return n}function W(t,e,r){var o;const a=Date.now()-c.startTime,n=t/e,s=n>0?Math.round(a/n*(1-n)):0;postMessage({type:"PROGRESS",workerId:c.workerId,progress:{currentStep:t,totalSteps:e,elapsedTime:a,estimatedTimeRemaining:s,matchesFound:r,currentDateTime:(o=c.chunk)==null?void 0:o.startDateTime.toISOString()}})}self.onmessage=async t=>{const{type:e,conditions:r,targetSeeds:a,workerId:n,chunk:s}=t.data;switch(n!==void 0&&(c.workerId=n),e){case"START_SEARCH":if(!r||!a||!s){postMessage({type:"ERROR",workerId:c.workerId,error:"Missing required parameters for search"});return}c.chunk=s,c.isRunning=!0,c.shouldStop=!1,c.isPaused=!1;try{await N(),await G(r,a)}catch(o){postMessage({type:"ERROR",workerId:c.workerId,error:o instanceof Error?o.message:"Unknown error"})}finally{c.isRunning=!1}break;case"PAUSE_SEARCH":c.isPaused=!0,postMessage({type:"PAUSED",workerId:c.workerId});break;case"RESUME_SEARCH":c.isPaused=!1,postMessage({type:"RESUMED",workerId:c.workerId});break;case"STOP_SEARCH":c.shouldStop=!0,c.isRunning=!1,postMessage({type:"STOPPED",workerId:c.workerId});break;case"PING":postMessage({type:"INITIALIZED",workerId:c.workerId,message:`Pong from worker ${c.workerId}`});break;default:console.warn(`Worker ${c.workerId}: Unknown message type:`,e)}};postMessage({type:"READY",workerId:c.workerId,message:`Parallel worker ${c.workerId} initialized`});
